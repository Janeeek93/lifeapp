<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS – Plany i Progres</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    :root {
      --bg: radial-gradient(circle at 0% -10%, rgba(99, 102, 241, 0.22), transparent 60%), #0f172a;
      --surface: rgba(15, 23, 42, 0.92);
      --surface-alt: rgba(30, 41, 59, 0.7);
      --surface-strong: rgba(51, 65, 85, 0.85);
      --ink: #e2e8f0;
      --text: #f8fafc;
      --muted: rgba(226, 232, 240, 0.65);
      --border: rgba(148, 163, 184, 0.22);
      --border-strong: rgba(148, 163, 184, 0.35);
      --accent: #60a5fa;
      --accent-strong: #2563eb;
      --accent-soft: rgba(96, 165, 250, 0.16);
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --green: #34d399;
      --orange: #f97316;
      --blue: #60a5fa;
      --radius-lg: 20px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --shadow-sm: 0 10px 30px rgba(15, 23, 42, 0.35);
      --shadow: 0 24px 50px rgba(15, 23, 42, 0.45);
      --transition: all .24s cubic-bezier(0.4, 0, 0.2, 1);
      --run-color: #22c55e;
      --run-soft: rgba(34, 197, 94, 0.12);
      --run-border: rgba(34, 197, 94, 0.24);
      --gym-color: #a855f7;
      --gym-soft: rgba(168, 85, 247, 0.18);
      --gym-border: rgba(168, 85, 247, 0.32);
      --read-color: #38bdf8;
      --read-soft: rgba(56, 189, 248, 0.18);
      --read-border: rgba(56, 189, 248, 0.32);
      --health-color: #f97316;
      --health-soft: rgba(249, 115, 22, 0.14);
      --health-border: rgba(249, 115, 22, 0.3);
      --mind-color: #60a5fa;
      --mind-soft: rgba(96, 165, 250, 0.14);
      --mind-border: rgba(96, 165, 250, 0.32);
      --balance-color: #2dd4bf;
      --balance-soft: rgba(45, 212, 191, 0.16);
      --balance-border: rgba(45, 212, 191, 0.32);
      --relationship-color: #c084fc;
      --relationship-soft: rgba(192, 132, 252, 0.16);
      --relationship-border: rgba(192, 132, 252, 0.32);
      --growth-color: #facc15;
      --growth-soft: rgba(250, 204, 21, 0.14);
      --growth-border: rgba(250, 204, 21, 0.32);
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13.5px;
      line-height: 1.5;
      color: var(--text);
      background: var(--bg);
      background-attachment: fixed;
      padding-bottom: 64px;
    }
    a { color: inherit; }
    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 28px 28px 80px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      padding: 18px 20px;
      backdrop-filter: blur(18px);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      opacity: 0.7;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .card.compact { padding: 16px 18px; }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { transition: none !important; animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; }
    }
    h1, h2, h3, h4 { margin: 0; font-weight: 700; letter-spacing: -0.01em; }
    h1 { font-size: 24px; }
    h2 { font-size: 18px; }
    h3 { font-size: 17px; }
    h4 { font-size: 14px; }
    p { margin: 0; }
    .muted { color: var(--muted); }
    .tiny { font-size: 11px; color: var(--muted); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: rgba(96, 165, 250, 0.16);
      color: var(--blue);
      padding: 6px 12px;
      font-weight: 600;
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .icon { width: 16px; height: 16px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: var(--accent-strong);
      color: #fff;
      font-weight: 600;
      font-size: 12.5px;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.28);
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 14px 32px rgba(37, 99, 235, 0.32); }
    .btn.soft {
      background: rgba(148, 163, 184, 0.12);
      color: var(--text);
      border-color: rgba(148, 163, 184, 0.24);
      box-shadow: none;
    }
    .btn.soft:hover { background: rgba(148, 163, 184, 0.2); }
    .btn.ghost {
      background: transparent;
      border-color: rgba(148, 163, 184, 0.18);
      color: var(--muted);
      box-shadow: none;
    }
    .btn.ghost:hover { color: var(--text); border-color: rgba(148, 163, 184, 0.3); }
    .btn.secondary { background: var(--accent); color: #0f172a; box-shadow: 0 12px 22px rgba(96, 165, 250, 0.26); }
    .btn.secondary:hover { background: var(--blue); color: #0f172a; }
    .btn.sm { padding: 6px 12px; font-size: 11.5px; border-radius: 10px; }
    .workspace {
      display: grid;
      grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
      gap: 20px;
      align-items: start;
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 28px;
      align-self: start;
    }
    .main-column { display: flex; flex-direction: column; gap: 16px; }
    .topbar {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 20px 22px;
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.16), rgba(14, 165, 233, 0.12));
    }
    .brand {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand-copy { display: grid; gap: 6px; }
    .brand h1 { font-size: 22px; }
    .brand-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .top-metrics {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .metric-chip {
      display: grid;
      gap: 2px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.2);
      min-width: 160px;
      animation: fadeUp 0.5s ease both;
    }
    .metric-chip span { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    .metric-chip strong { font-size: 18px; font-weight: 700; }
    .week-card { display: grid; gap: 14px; }
    .week-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .week-card h2 { font-size: 17px; }
    .week-controls { display: flex; gap: 6px; flex-wrap: wrap; }
    .progress-track { display: grid; gap: 6px; }
    .progress-bar { height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.2); overflow: hidden; }
    .progress-bar > div { height: 100%; background: var(--accent); border-radius: inherit; transition: width .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .copy-plan { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .copy-plan .btn { box-shadow: none; }
    .focus-card { display: grid; gap: 14px; }
    .focus-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .focus-highlight { display: grid; text-align: right; gap: 4px; }
    .focus-highlight strong { font-size: 22px; color: var(--accent); }
    .notes-grid { display: grid; gap: 12px; }
    .note-field { display: grid; gap: 6px; }
    .note-field label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    textarea {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      padding: 12px;
      min-height: 90px;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
      transition: var(--transition);
    }
    textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.18); }
    input[type="text"], input[type="number"], select {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      padding: 9px 12px;
      font-family: inherit;
      font-size: 13px;
      transition: var(--transition);
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.18);
    }
    .inline-fields { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .radio-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: var(--transition);
      background: rgba(15, 23, 42, 0.55);
    }
    .radio-chip:hover { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); }
    .checkbox-line { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
    .goals-card { display: grid; gap: 12px; }
    .goal-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
    .goal-matrix { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .goal-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px;
      background: rgba(255, 255, 255, 0.02);
      display: grid;
      gap: 10px;
      position: relative;
      overflow: hidden;
      animation: fadeUp 0.5s ease both;
    }
    .goal-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(255,255,255,0.08), transparent 60%);
      opacity: 0;
      transition: var(--transition);
    }
    .goal-card:hover::before { opacity: 1; }
    .goal-card-header { display: flex; align-items: center; gap: 10px; }
    .goal-icon {
      width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 10px;
      background: rgba(255,255,255,0.12);
      font-size: 16px;
    }
    .goal-title { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 600; }
    .goal-card .kpi-value { font-size: 18px; font-weight: 700; }
    .goal-target { font-size: 11px; color: var(--muted); }
    .goal-card .btn { width: 100%; justify-content: center; font-size: 12px; background: rgba(255,255,255,0.1); color: inherit; box-shadow: none; }
    .goal-card .btn:hover { background: rgba(255,255,255,0.2); }
    .tab-card { padding: 0; }
    .tabs {
      display: flex;
      gap: 8px;
      padding: 16px 18px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.18);
      flex-wrap: wrap;
    }
    .tab {
      padding: 7px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12.5px;
      color: var(--muted);
      border: 1px solid transparent;
      background: rgba(15, 23, 42, 0.45);
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab:hover { color: var(--text); border-color: rgba(148, 163, 184, 0.24); }
    .tab.active { background: var(--accent); color: #0f172a; box-shadow: 0 12px 24px rgba(96, 165, 250, 0.28); }
    .tab-panels { padding: 18px 20px 22px; display: grid; gap: 18px; }
    .tab-panel { display: none; animation: fadeUp 0.4s ease both; }
    .tab-panel.active { display: block; }
    .planner-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
    .status-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: rgba(96,165,250,0.16); color: var(--accent); font-weight: 600; }
    .planner-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      align-items: start;
    }
    .day-column {
      background: rgba(15, 23, 42, 0.6);
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
      position: relative;
      transition: var(--transition);
    }
    .day-column::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: 1px solid transparent;
      transition: var(--transition);
      opacity: 0;
    }
    .day-column:hover::after, .day-column.drag-over::after {
      border-color: rgba(96, 165, 250, 0.45);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.35);
      opacity: 1;
    }
    .day-header { font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; font-size: 10px; color: var(--muted); border-bottom: 1px dashed rgba(148, 163, 184, 0.28); padding-bottom: 6px; }
    .day-header.today { color: var(--accent); }
    .activities-container { display: flex; flex-direction: column; gap: 6px; flex: 1; min-height: 24px; }
    .activity-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: var(--radius-sm);
      padding: 7px 9px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(148, 163, 184, 0.12);
      color: var(--text);
      border: 1px solid transparent;
      cursor: grab;
      transition: var(--transition);
      animation: floatUp 0.45s ease both;
    }
    .activity-pill:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(15, 23, 42, 0.35); }
    .activity-pill.dragging { opacity: 0.45; transform: scale(1.02); box-shadow: var(--shadow); }
    .activity-pill .pill-content { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
    .activity-pill .pill-label { display: flex; align-items: center; gap: 6px; min-width: 0; }
    .activity-pill .pill-label span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .activity-pill .pill-meta { margin-left: auto; font-size: 10.5px; color: rgba(226, 232, 240, 0.78); }
    .activity-pill.completed { background: rgba(52, 211, 153, 0.16); color: var(--success); border-color: rgba(52, 211, 153, 0.4); cursor: pointer; }
    .activity-pill.completed .pill-meta { color: var(--success); }
    .activity-pill.completed .pill-label span { text-decoration: line-through; opacity: 0.85; }
    .custom-pill { border-color: rgba(255, 255, 255, 0.08); }
    .quick-add-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 10px;
      padding: 5px 9px;
      color: var(--muted);
      font-weight: 600;
      font-size: 10.5px;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
    }
    .day-column:hover .quick-add-btn { opacity: 1; pointer-events: auto; transform: translateY(-2px); }
    .quick-add-menu {
      position: absolute;
      top: 36px;
      right: 8px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.32);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: none;
      flex-direction: column;
      overflow: hidden;
      min-width: 180px;
      z-index: 10;
    }
    .quick-add-menu button {
      background: none;
      border: none;
      padding: 10px 12px;
      text-align: left;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
      cursor: pointer;
    }
    .quick-add-menu button:hover { background: rgba(96, 165, 250, 0.16); }
    .delete-activity-btn {
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.28);
      color: var(--muted);
      padding: 4px;
      border-radius: 10px;
      display: flex;
      transition: var(--transition);
      margin-left: 6px;
    }
    .delete-activity-btn:hover { color: var(--danger); background: rgba(248, 113, 113, 0.14); }
    .empty-planner {
      margin-top: 10px;
      border: 1px dashed rgba(148, 163, 184, 0.4);
      border-radius: var(--radius-md);
      padding: 18px;
      text-align: center;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.55);
    }
    .custom-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .summary-pill {
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      background: rgba(96, 165, 250, 0.12);
      color: var(--blue);
      font-weight: 600;
      display: grid;
      gap: 2px;
      animation: fadeUp 0.45s ease both;
    }
    .summary-pill span { font-size: 18px; font-weight: 700; color: var(--text); }
    .template-wrapper { display: grid; gap: 10px; }
    .template-list { display: grid; gap: 10px; }
    .template-card {
      border: 1px solid rgba(148, 163, 184, 0.24);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      transition: var(--transition);
    }
    .template-card:hover { border-color: rgba(96, 165, 250, 0.3); box-shadow: 0 16px 30px rgba(15, 23, 42, 0.45); }
    .template-meta { display: flex; flex-direction: column; gap: 2px; }
    .template-meta strong { font-size: 13px; }
    .template-actions { display: flex; gap: 8px; }
    .empty-state {
      border: 1px dashed rgba(148, 163, 184, 0.4);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
      color: var(--muted);
      background: rgba(15, 23, 42, 0.45);
    }
    .empty-state.small { padding: 12px; font-size: 12px; }
    .stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .stats-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.55);
      padding: 14px;
      display: grid;
      gap: 4px;
    }
    .stats-card span.stats-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 600; }
    .stats-card strong { font-size: 20px; font-weight: 700; }
    .stats-card .stats-sub { font-size: 11.5px; color: var(--muted); }
    .stats-panels { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .stats-panel {
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.55);
      padding: 14px;
      display: grid;
      gap: 12px;
    }
    .panel-header { display: grid; gap: 2px; }
    .panel-header h4 { font-size: 13.5px; letter-spacing: 0.01em; }
    .goal-progress { display: grid; gap: 10px; }
    .goal-progress-bar { display: grid; gap: 6px; }
    .goal-progress-head { display: flex; justify-content: space-between; font-weight: 600; font-size: 12px; }
    .goal-progress-track { height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.22); overflow: hidden; }
    .goal-progress-track span { display: block; height: 100%; border-radius: inherit; transition: width .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .category-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
    .category-pill { border-radius: 999px; padding: 7px 12px; font-size: 11.5px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; background: rgba(15, 23, 42, 0.6); color: var(--text); }
    .category-pill span { font-size: 10.5px; color: var(--muted); }
    .recent-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .recent-list li {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.22);
    }
    .recent-list li strong { font-size: 12.5px; }
    .recent-value { font-size: 12px; font-weight: 700; color: var(--accent); }
    .monthly-bars { display: flex; align-items: flex-end; gap: 10px; height: 130px; }
    .monthly-bar { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; gap: 4px; font-size: 11.5px; color: var(--muted); }
    .monthly-bar strong { font-size: 11.5px; color: var(--text); }
    .monthly-bar-fill { width: 100%; min-height: 4px; border-radius: 8px 8px 4px 4px; background: linear-gradient(180deg, rgba(96, 165, 250, 0.45), rgba(14, 165, 233, 0.18)); display: flex; align-items: flex-end; justify-content: center; position: relative; overflow: hidden; }
    .monthly-bar-fill span { position: absolute; bottom: 6px; font-size: 11px; font-weight: 600; color: var(--accent); }
    .trend-list { display: grid; gap: 8px; }
    .trend-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }
    .trend-info { display: grid; gap: 2px; }
    .trend-info strong { font-size: 12.5px; }
    .trend-focus { font-size: 11px; color: var(--muted); }
    .trend-progress { flex: 1; display: grid; gap: 6px; }
    .trend-bar { height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.2); overflow: hidden; }
    .trend-bar span { display: block; height: 100%; border-radius: inherit; background: var(--accent); }
    .weekday-bars { display: grid; gap: 8px; }
    .weekday-item { display: grid; grid-template-columns: 60px 1fr auto; gap: 8px; align-items: center; }
    .weekday-track { height: 6px; border-radius: 999px; background: rgba(148, 163, 184, 0.2); overflow: hidden; position: relative; }
    .weekday-track span { display: block; height: 100%; border-radius: inherit; background: rgba(96, 165, 250, 0.7); }
    .weekday-track::after { content: attr(data-label); position: absolute; right: 6px; top: -16px; font-size: 9.5px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .leaderboard { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
    .leaderboard li { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 10px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.22); }
    .leaderboard strong { font-size: 12.5px; }
    .leaderboard span { font-size: 11px; color: var(--muted); }
    .heatmap-panel { background: transparent; border: none; padding: 0; gap: 10px; }
    .heatmap-container { overflow-x: auto; padding: 16px; border-radius: var(--radius-md); background: rgba(15, 23, 42, 0.65); border: 1px solid rgba(148, 163, 184, 0.24); }
    .heatmap { display: grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 3px; }
    .heatmap-cell { width: 14px; height: 14px; background: rgba(148, 163, 184, 0.18); border-radius: 3px; position: relative; }
    .heatmap-cell[data-level="1"] { background: #9be9a8; }
    .heatmap-cell[data-level="2"] { background: #40c463; }
    .heatmap-cell[data-level="3"] { background: #30a14e; }
    .heatmap-cell[data-level="4"] { background: #216e39; }
    .heatmap-legend { display: flex; align-items: center; gap: 6px; justify-content: flex-end; font-size: 10.5px; color: var(--muted); padding: 0 16px 16px; }
    #save-status {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(30px);
      background: rgba(15, 23, 42, 0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease, transform .3s ease;
      font-weight: 600;
    }
    #save-status.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(8, 12, 22, 0.72);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      backdrop-filter: blur(6px);
    }
    .modal-overlay.visible { opacity: 1; pointer-events: auto; }
    .modal-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-lg);
      padding: 26px;
      box-shadow: var(--shadow);
      width: min(460px, 92vw);
      display: grid;
      gap: 14px;
      transform: translateY(12px);
      transition: transform .25s ease;
      border: 1px solid rgba(148, 163, 184, 0.28);
    }
    .modal-overlay.visible .modal-card { transform: translateY(0); }
    .modal-actions { display: flex; justify-content: center; gap: 12px; margin-top: 6px; flex-wrap: wrap; }
    .modal-options { display: grid; gap: 10px; }
    .option-label {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(15, 23, 42, 0.6);
    }
    .option-label:hover { border-color: var(--accent); background: rgba(96, 165, 250, 0.16); }
    .planning-mode .planner-grid { filter: saturate(1.15); }
    .planning-mode .day-column { border-style: dashed; border-color: rgba(96, 165, 250, 0.55); background: rgba(96, 165, 250, 0.14); }
    .planning-mode .day-column::after { opacity: 0 !important; }
    .planning-mode .day-column:hover { background: rgba(96, 165, 250, 0.22); }
    .planning-mode .day-column:hover .quick-add-btn { opacity: 0; pointer-events: none; }
    .input-error { border-color: var(--danger) !important; box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.3) !important; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes floatUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 1100px) {
      .workspace { grid-template-columns: 1fr; }
      .sidebar { position: static; }
    }
    @media (max-width: 768px) {
      .app-shell { padding: 20px 18px 72px; }
      .tabs { padding: 14px 16px 0; }
      .tab-panels { padding: 16px; }
      .planner-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    }
    @media (max-width: 560px) {
      .brand { flex-direction: column; align-items: flex-start; }
      .brand-actions { width: 100%; }
      .brand-actions .btn { flex: 1; justify-content: center; }
      .week-controls { width: 100%; }
      .planner-grid { grid-template-columns: 1fr; }
      .inline-fields { grid-template-columns: 1fr; }
    }
  </style>

</head>

<body>
  <div class="app-shell">
    <header class="card topbar">
      <div class="brand">
        <div class="brand-copy">
          <span class="badge"><i data-lucide="sparkles" class="icon"></i>LifeOS</span>
          <h1>Pulpit tygodnia</h1>
          <p class="muted">Zaplanuj tydzień w kilku krokach i miej statystyki zawsze pod ręką.</p>
        </div>
        <div class="brand-actions">
          <a href="./index.html" class="btn soft"><i data-lucide="arrow-left" class="icon"></i>Powrót</a>
          <button id="jump-to-planner" class="btn secondary"><i data-lucide="target" class="icon"></i>Planer</button>
        </div>
      </div>
      <div class="top-metrics">
        <div class="metric-chip">
          <span>Postęp tygodnia</span>
          <strong id="top-week-progress">0%</strong>
          <span class="tiny muted">Średnia realizacja celów</span>
        </div>
        <div class="metric-chip">
          <span>Ukończone tygodnie</span>
          <strong id="yearly-progress-value">0/36</strong>
        </div>
        <div class="metric-chip">
          <span>Seria konsekwencji</span>
          <strong id="streak-value">0</strong>
        </div>
        <div class="metric-chip">
          <span>Aktywności własne</span>
          <strong data-role="custom-count">0</strong>
          <span class="tiny muted">zaplanowane w tym tygodniu</span>
        </div>
      </div>
    </header>

    <div class="workspace">
      <aside class="sidebar">
        <section class="card week-card compact">
          <div class="week-card-header">
            <div>
              <span class="badge"><i data-lucide="calendar-days" class="icon"></i>Bieżący tydzień</span>
              <h2 id="week-title">Cele na ten tydzień</h2>
              <p class="tiny muted">Nawiguj między tygodniami i kopiuj plan jednym kliknięciem.</p>
            </div>
            <div class="week-controls">
              <button id="prev-week-btn" class="btn ghost sm"><i data-lucide="chevron-left" class="icon"></i>Poprzedni</button>
              <button id="today-week-btn" class="btn ghost sm" style="display:none;">Bieżący</button>
              <button id="next-week-btn" class="btn ghost sm">Następny<i data-lucide="chevron-right" class="icon"></i></button>
            </div>
          </div>
          <div class="copy-plan">
            <button id="copy-plan-btn" class="btn soft sm" style="display:none;"><i data-lucide="copy" class="icon"></i>Kopiuj plan</button>
            <span class="tiny muted">Przeniesiesz dzięki temu ulubiony układ.</span>
          </div>
          <div class="progress-track">
            <span id="overall-progress-label" class="tiny muted">Postęp tygodnia: 0%</span>
            <div class="progress-bar"><div id="overall-progress-bar" style="width:0%;"></div></div>
          </div>
        </section>

        <section class="card compact focus-card" id="weekly-focus-card">
          <div class="focus-header">
            <div>
              <span class="badge"><i data-lucide="compass" class="icon"></i>Skupienie tygodnia</span>
              <h3>Ustal mentalny kierunek</h3>
              <p class="tiny muted">Notuj najważniejsze akcenty, by szybciej wejść w rytm.</p>
            </div>
            <div class="focus-highlight">
              <span class="tiny muted">Własne aktywności</span>
              <strong data-role="custom-count">0</strong>
              <span class="tiny muted">zaplanowane</span>
            </div>
          </div>
          <div class="notes-grid">
            <div class="note-field">
              <label for="week-focus-input">Priorytet tygodnia</label>
              <textarea id="week-focus-input" placeholder="Opisz najważniejszy efekt do dowiezienia..."></textarea>
            </div>
            <div class="note-field">
              <label for="week-highlight-input">Obserwacje i sukcesy</label>
              <textarea id="week-highlight-input" placeholder="Zapisuj mikro-sukcesy, spostrzeżenia, dobre praktyki..."></textarea>
            </div>
          </div>
        </section>

        <section class="card compact" id="custom-activities-card">
          <div class="goal-header">
            <div>
              <span class="badge"><i data-lucide="sparkles" class="icon"></i>Aktywności dodatkowe</span>
              <h3>Biblioteka rytuałów</h3>
              <p class="tiny muted">Dodawaj treningi, regenerację i projekty niezależne od głównych celów.</p>
            </div>
            <button id="add-custom-activity-btn" class="btn secondary sm"><i data-lucide="plus-circle" class="icon"></i>Nowa aktywność</button>
          </div>
          <div id="custom-summary" class="custom-summary"></div>
          <div class="template-wrapper">
            <div class="goal-header">
              <h4>Ulubione szablony</h4>
              <p class="tiny muted">Zapisz aktywność podczas dodawania, by mieć ją pod ręką.</p>
            </div>
            <div id="custom-template-list" class="template-list"></div>
          </div>
        </section>
      </aside>

      <section class="main-column">
        <section class="card compact goals-card">
          <div class="goal-header">
            <div>
              <span class="badge"><i data-lucide="layers" class="icon"></i>Cele tygodnia</span>
              <h3>Twoje priorytety</h3>
            </div>
            <p class="tiny muted">Dodawaj treningi jednym kliknięciem.</p>
          </div>
          <div class="goal-matrix">
            <div class="goal-card" style="border-color: var(--gym-border); background: var(--gym-soft); color: var(--text);">
              <div class="goal-card-header">
                <div class="goal-icon">💪</div>
                <div>
                  <span class="goal-title">Trening siłowy</span>
                  <span class="goal-target">Cel: 3 sesje</span>
                </div>
              </div>
              <div id="goal-gym-progress" class="kpi-value">0/3 sesje</div>
              <div class="progress-bar"><div id="goal-gym-bar" style="width:0%; background: var(--gym-color);"></div></div>
              <button class="btn soft" data-activity-type="gym" data-action="plan"><i data-lucide="plus-circle" class="icon"></i>Zaplanuj</button>
            </div>
            <div class="goal-card" style="border-color: var(--run-border); background: var(--run-soft); color: var(--text);">
              <div class="goal-card-header">
                <div class="goal-icon">🏃</div>
                <div>
                  <span class="goal-title">Bieg</span>
                  <span class="goal-target">Cel: 5 km</span>
                </div>
              </div>
              <div id="goal-running-progress" class="kpi-value">0/5 km</div>
              <div class="progress-bar"><div id="goal-running-bar" style="width:0%; background: var(--run-color);"></div></div>
              <button class="btn soft" data-activity-type="running" data-action="plan"><i data-lucide="plus-circle" class="icon"></i>Zaplanuj</button>
            </div>
            <div class="goal-card" style="border-color: var(--read-border); background: var(--read-soft); color: var(--text);">
              <div class="goal-card-header">
                <div class="goal-icon">📚</div>
                <div>
                  <span class="goal-title">Czytanie</span>
                  <span class="goal-target">Cel: 100 stron</span>
                </div>
              </div>
              <div id="goal-reading-progress" class="kpi-value">0/100 stron</div>
              <div class="progress-bar"><div id="goal-reading-bar" style="width:0%; background: var(--read-color);"></div></div>
              <button class="btn soft" data-activity-type="reading" data-action="plan"><i data-lucide="plus-circle" class="icon"></i>Zaplanuj</button>
            </div>
          </div>
        </section>

        <section class="card tab-card">
          <div class="tabs">
            <div class="tab active" data-tab="planner"><i data-lucide="layout-grid" class="icon"></i>Planer</div>
            <div class="tab" data-tab="stats"><i data-lucide="trending-up" class="icon"></i>Statystyki</div>
          </div>
          <div class="tab-panels">
            <div id="tab-content-planner" class="tab-panel active">
              <div class="planner-header">
                <div>
                  <h3>Planer tygodniowy</h3>
                  <p id="planning-status" class="tiny muted status-chip"></p>
                </div>
                <div class="planner-actions">
                  <button id="cancel-planning-btn" class="btn soft sm" style="display:none;"><i data-lucide="x-circle" class="icon"></i>Zakończ planowanie</button>
                </div>
              </div>
              <p id="planning-instructions" class="tiny muted" style="display:none;"></p>
              <div class="planner-grid"></div>
              <div id="empty-planner-placeholder" class="empty-planner" style="display:none;">
                <h4>Twój tydzień jest pusty</h4>
                <p class="muted">Dodaj aktywności z kart celów lub skopiuj plan z poprzedniego tygodnia.</p>
              </div>
            </div>
            <div id="tab-content-stats" class="tab-panel">
              <div class="stats-overview">
                <div class="stats-card">
                  <span class="stats-label">Wszystkie aktywności</span>
                  <strong id="stats-total-activities">0</strong>
                  <span id="stats-completion-rate" class="stats-sub">Brak danych</span>
                </div>
                <div class="stats-card">
                  <span class="stats-label">Cele tygodnia</span>
                  <strong id="stats-goal-performance">0%</strong>
                  <span id="stats-goal-summary" class="stats-sub">Brak tygodni</span>
                </div>
                <div class="stats-card">
                  <span class="stats-label">Aktywności własne</span>
                  <strong id="stats-custom-activities">0</strong>
                  <span id="stats-custom-value" class="stats-sub">Łączna wartość: 0</span>
                </div>
              </div>
              <div class="stats-panels">
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Postęp celów</h4>
                    <span class="tiny muted">Średni poziom realizacji na przestrzeni tygodni</span>
                  </div>
                  <div id="stats-goal-breakdown" class="goal-progress"></div>
                </div>
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Najaktywniejsze obszary</h4>
                    <span class="tiny muted">Własne aktywności pogrupowane według kategorii</span>
                  </div>
                  <div id="stats-top-categories" class="category-cloud"></div>
                </div>
              </div>
              <div class="stats-panels">
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Ostatnie sukcesy</h4>
                    <span class="tiny muted">Świeżo ukończone działania</span>
                  </div>
                  <ul id="stats-recent-list" class="recent-list"></ul>
                </div>
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Aktywność miesięczna</h4>
                    <span class="tiny muted">Ukończenia w ciągu ostatnich miesięcy</span>
                  </div>
                  <div id="stats-monthly-bars" class="monthly-bars"></div>
                </div>
              </div>
              <div class="stats-panels">
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Dynamika tygodni</h4>
                    <span class="tiny muted">Ostatnie sześć tygodni</span>
                  </div>
                  <div id="stats-week-trend" class="trend-list"></div>
                </div>
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Najmocniejsze dni</h4>
                    <span class="tiny muted">Ukończenia według dnia tygodnia</span>
                  </div>
                  <div id="stats-weekday-chart" class="weekday-bars"></div>
                </div>
                <div class="stats-panel">
                  <div class="panel-header">
                    <h4>Top aktywności</h4>
                    <span class="tiny muted">Najczęściej realizowane zadania</span>
                  </div>
                  <ul id="stats-top-activities" class="leaderboard"></ul>
                </div>
              </div>
              <div class="stats-panel heatmap-panel">
                <div class="panel-header">
                  <h4>Kalendarz aktywności</h4>
                  <span class="tiny muted">Każdy kwadrat to jeden dzień. Im jaśniejszy kolor, tym więcej ukończeń.</span>
                </div>
                <div class="heatmap-container"></div>
                <div class="heatmap-legend">
                  <span class="tiny muted">Mniej</span>
                  <div class="heatmap-cell" style="background: rgba(148, 163, 184, 0.18);"></div>
                  <div class="heatmap-cell" data-level="1"></div>
                  <div class="heatmap-cell" data-level="2"></div>
                  <div class="heatmap-cell" data-level="3"></div>
                  <div class="heatmap-cell" data-level="4"></div>
                  <span class="tiny muted">Więcej</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </section>
    </div>
  </div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title" class="title" style="justify-content: center;"></h3>
    <p id="modal-text" class="muted"></p>
    <div id="modal-input-container"></div>
    <div id="modal-options-container"></div>
    <div id="modal-actions" class="modal-actions"></div>
  </div>
</div>

<div id="save-status">Zapisano!</div>

<script>
// --- KONFIGURACJA ---
const STORAGE_KEY = 'lifeos_trainings_v1';
const GOAL_DEFINITIONS = {
    gym: { target: 3, unit: 'sesje', label: 'Trening siłowy', icon: 'dumbbell', color: 'var(--gym-color)', bg: 'var(--gym-soft)', border: 'var(--gym-border)', trackValue: false },
    running: { target: 5, unit: 'km', label: 'Bieg', icon: 'activity', color: 'var(--run-color)', bg: 'var(--run-soft)', border: 'var(--run-border)', trackValue: true },
    reading: { target: 100, unit: 'stron', label: 'Czytanie', icon: 'book-open-check', color: 'var(--read-color)', bg: 'var(--read-soft)', border: 'var(--read-border)', trackValue: true }
};
const CUSTOM_ACTIVITY_CATEGORIES = {
    body: { label: 'Trening / Ciało', color: 'var(--health-color)', bg: 'var(--health-soft)', border: 'var(--health-border)', icon: 'armchair' },
    mind: { label: 'Umysł / Nauka', color: 'var(--mind-color)', bg: 'var(--mind-soft)', border: 'var(--mind-border)', icon: 'brain' },
    balance: { label: 'Regeneracja', color: 'var(--balance-color)', bg: 'var(--balance-soft)', border: 'var(--balance-border)', icon: 'leaf' },
    relationship: { label: 'Relacje', color: 'var(--relationship-color)', bg: 'var(--relationship-soft)', border: 'var(--relationship-border)', icon: 'users' },
    growth: { label: 'Rozwój / Projekt', color: 'var(--growth-color)', bg: 'var(--growth-soft)', border: 'var(--growth-border)', icon: 'rocket' },
    other: { label: 'Inne', color: 'var(--ink)', bg: 'rgba(15,23,42,0.08)', border: 'rgba(15,23,42,0.12)', icon: 'sparkles' }
};
const CUSTOM_TRACK_TYPES = { CHECK: 'check', VALUE: 'value' };
const DAY_NAMES = ['Niedz', 'Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob'];

let state = {};
let currentDate = new Date();
let planningState = { isPlanning: false, activityType: null };
let dragState = { activityId: null, sourceDay: null };
let saveTimeout;
let notesSaveTimer;

// --- POMOCNICZE FUNKCJE ---
function ensureGlobalState() {
    if (!state.__meta || typeof state.__meta !== 'object') state.__meta = {};
    if (!Array.isArray(state.__meta.templates)) state.__meta.templates = [];
}

function getTemplateCollection() {
    ensureGlobalState();
    return state.__meta.templates;
}

function setTemplateCollection(templates) {
    ensureGlobalState();
    state.__meta.templates = templates;
}

function getYearKeys() {
    return Object.keys(state).filter(key => /^\d{4}$/.test(key));
}

function isGoalType(type) {
    return Boolean(GOAL_DEFINITIONS[type]);
}

function getCategoryStyles(category) {
    return CUSTOM_ACTIVITY_CATEGORIES[category] || CUSTOM_ACTIVITY_CATEGORIES.other;
}

function getActivityDefinition(activity) {
    if (GOAL_DEFINITIONS[activity.type]) {
        const goal = GOAL_DEFINITIONS[activity.type];
        return { ...goal, type: activity.type, label: goal.label, categoryLabel: 'Cel tygodnia', trackType: goal.trackValue ? CUSTOM_TRACK_TYPES.VALUE : CUSTOM_TRACK_TYPES.CHECK };
    }
    const custom = activity.custom || {};
    const styles = getCategoryStyles(custom.category);
    return {
        type: 'custom',
        label: custom.name || 'Aktywność',
        unit: custom.unit || '',
        icon: custom.icon || styles.icon,
        color: custom.color || styles.color,
        bg: custom.bg || styles.bg,
        border: custom.border || styles.border,
        trackValue: custom.trackType === CUSTOM_TRACK_TYPES.VALUE,
        trackType: custom.trackType || CUSTOM_TRACK_TYPES.CHECK,
        categoryLabel: styles.label
    };
}

function formatNumber(value) {
    if (value === undefined || value === null || value === '') return '';
    const number = Number(value);
    if (Number.isNaN(number)) return '';
    return number.toLocaleString('pl-PL');
}

// --- STAN APLIKACJI ---
function loadState() {
    state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    ensureGlobalState();
}
function saveState() { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const saveStatus = document.getElementById('save-status');
    clearTimeout(saveTimeout);
    saveStatus.classList.add('visible');
    saveTimeout = setTimeout(() => saveStatus.classList.remove('visible'), 1500);
}

// --- POMOCNICY DATY ---
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    return [d.getUTCFullYear(), weekNo];
}
function getStartOfWeek(year, week) {
    const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
    const day = d.getUTCDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setUTCDate(diff));
}
function toYYYYMMDD(date) { return date.toISOString().slice(0, 10); }

// --- LOGIKA BIZNESOWA ---
function initializeWeekData(year, week) {
    if (!state[year]) state[year] = {};
    if (!state[year][week]) {
        state[year][week] = {
            progress: { gym: 0, running: 0, reading: 0 },
            plan: { 1:[], 2:[], 3:[], 4:[], 5:[], 6:[], 0:[] },
            isComplete: false,
            summaryShown: false,
            notes: { focus: '', highlight: '' }
        };
    }
    if (!state[year][week].progress) {
        state[year][week].progress = { gym: 0, running: 0, reading: 0 };
    }
    if (!state[year][week].plan) {
        state[year][week].plan = { 1:[], 2:[], 3:[], 4:[], 5:[], 6:[], 0:[] };
    }
    Object.keys({ 1:1, 2:1, 3:1, 4:1, 5:1, 6:1, 0:1 }).forEach(dayKey => {
        if (!Array.isArray(state[year][week].plan[dayKey])) state[year][week].plan[dayKey] = [];
    });
    if (!state[year][week].notes) {
        state[year][week].notes = { focus: '', highlight: '' };
    }
}

function addActivity(type, dayIndex, plannedValue, extra = {}) {
    const [year, week] = getWeekNumber(currentDate);
    const weekData = state[year][week];
    const newActivity = {
        id: `act_${Date.now()}_${Math.random()}`,
        type: type,
        completed: false,
        day: dayIndex,
        plannedValue: plannedValue,
        loggedValue: 0,
        ...extra
    };
    if(!weekData.plan[dayIndex]) weekData.plan[dayIndex] = [];
    weekData.plan[dayIndex].push(newActivity);
    saveState();
    render();
}

function deleteActivity(activityId) {
    const [year, week] = getWeekNumber(currentDate);
    const weekData = state[year]?.[week];
    if (!weekData) return;

    let removed = false;
    for (const day in weekData.plan) {
        const initialLength = weekData.plan[day].length;
        weekData.plan[day] = weekData.plan[day].filter(a => a.id !== activityId);
        if (weekData.plan[day].length < initialLength) {
            removed = true;
            break;
        }
    }

    if (!removed) return;

    recalculateWeekProgress(year, week);
    checkWeekCompletion(year, week);
    saveState();
    render();
}

function confirmDeleteActivity(activityId) {
    const [year, week] = getWeekNumber(currentDate);
    const weekData = state[year]?.[week];
    if (!weekData) return;

    let activity = null;
    let dayKey = null;
    for (const day in weekData.plan) {
        const found = weekData.plan[day].find(a => a.id === activityId);
        if (found) {
            activity = found;
            dayKey = parseInt(day, 10);
            break;
        }
    }

    if (!activity) return;

    const definition = getActivityDefinition(activity);
    const startOfWeek = getStartOfWeek(year, week);
    const activityDate = new Date(startOfWeek);
    const numericDay = (typeof dayKey === 'number' && !Number.isNaN(dayKey)) ? dayKey : 1;
    const normalizedDay = (numericDay - 1 + 7) % 7;
    activityDate.setDate(startOfWeek.getDate() + normalizedDay);
    const dateLabel = activityDate.toLocaleDateString('pl-PL');
    const dayLabel = DAY_NAMES[numericDay] || DAY_NAMES[1];

    showModal({
        title: 'Usuń aktywność',
        text: 'Czy na pewno chcesz usunąć tę aktywność? Wszystkie zapisane postępy zostaną utracone.',
        content: (inputContainer) => {
            const details = document.createElement('div');
            details.className = 'tiny muted';
            details.style.marginTop = '16px';
            details.style.textAlign = 'left';
            details.style.background = 'rgba(148,163,184,0.12)';
            details.style.padding = '12px 14px';
            details.style.borderRadius = '12px';
            details.textContent = `${definition.label} • ${dayLabel} (${dateLabel})`;
            inputContainer.appendChild(details);
        },
        buttons: [
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Usuń', class: 'btn danger', action: () => deleteActivity(activityId) }
        ]
    });
}

function logActivity(activityId, value, isCompleted) {
    const [year, week] = getWeekNumber(currentDate);
    const weekData = state[year][week];
    let activityFound = null;
    for (const day in weekData.plan) {
        const activity = weekData.plan[day].find(a => a.id === activityId);
        if (activity) { activityFound = activity; break; }
    }
    if (activityFound) {
        activityFound.completed = isCompleted;
        activityFound.loggedValue = Number(value) || 0;
        recalculateWeekProgress(year, week);
        checkWeekCompletion(year, week);
        saveState();
        render();
    }
}

function recalculateWeekProgress(year, week) {
    const weekData = state[year][week];
    weekData.progress = {};
    Object.keys(GOAL_DEFINITIONS).forEach(type => weekData.progress[type] = 0);
    Object.values(weekData.plan).flat().forEach(activity => {
        if (activity.completed && GOAL_DEFINITIONS[activity.type]) {
            weekData.progress[activity.type] += (Number(activity.loggedValue) || 0);
        }
    });
}

function checkWeekCompletion(year, week) {
    const weekData = state[year][week];
    const allGoalsMet = Object.keys(GOAL_DEFINITIONS).every(type => 
        (weekData.progress[type] || 0) >= GOAL_DEFINITIONS[type].target
    );
    if (weekData.isComplete !== allGoalsMet) {
        weekData.isComplete = allGoalsMet;
    }
}

function copyPreviousWeek(copyProgress = false) {
    const [currentYear, currentWeek] = getWeekNumber(currentDate);
    
    let prevWeekDate = new Date(currentDate);
    prevWeekDate.setDate(prevWeekDate.getDate() - 7);
    const [prevYear, prevWeek] = getWeekNumber(prevWeekDate);

    const prevWeekData = state[prevYear]?.[prevWeek];
    if (!prevWeekData) return;

    // Deep copy of the plan
    const newPlan = JSON.parse(JSON.stringify(prevWeekData.plan));

    Object.values(newPlan).flat().forEach(activity => {
        activity.id = `act_${Date.now()}_${Math.random()}`; // New unique ID
        if (!copyProgress) {
            activity.completed = false;
            activity.loggedValue = 0;
        }
    });

    initializeWeekData(currentYear, currentWeek);
    state[currentYear][currentWeek].plan = newPlan;
    
    recalculateWeekProgress(currentYear, currentWeek);
    checkWeekCompletion(currentYear, currentWeek);
    saveState();
    render();
}


// --- FUNKCJE RENDERUJĄCE ---
function render() {
    const [year, week] = getWeekNumber(currentDate);
    initializeWeekData(year, week);
    
    const weekData = state[year][week];
    const startOfWeek = getStartOfWeek(year, week);
    
    document.getElementById('week-title').textContent = `Tydzień ${week} (${year})`;
    
    const todayBtn = document.getElementById('today-week-btn');
    const [currentYear, currentWeek] = getWeekNumber(new Date());
    todayBtn.style.display = (year === currentYear && week === currentWeek) ? 'none' : 'inline-flex';

    renderCopyPlanButton();
    renderGoals(weekData.progress);
    renderPlanner(weekData.plan, startOfWeek);
    renderHeaderKPIs(year);
    renderPlanningStatus(weekData.plan);
    renderOverallProgress(weekData.progress);
    renderWeeklyNotes(weekData);
    renderCustomSummary(weekData);
    renderCustomTemplates();
    if (document.querySelector('.tab.active')?.dataset.tab === 'stats') {
        renderStats();
    }
    lucide.createIcons();
}

function renderGoals(progress) {
    for (const type in GOAL_DEFINITIONS) {
        const goal = GOAL_DEFINITIONS[type];
        const currentProgress = parseFloat(progress[type] || 0);
        const progressPercent = Math.min(100, (currentProgress / goal.target) * 100);

        document.getElementById(`goal-${type}-progress`).textContent = `${currentProgress.toLocaleString('pl-PL')}/${goal.target} ${goal.unit}`;
        document.getElementById(`goal-${type}-bar`).style.width = `${progressPercent}%`;
    }
}

function renderPlanner(plan, startOfWeek) {
    const plannerGrid = document.querySelector('.planner-grid');
    const emptyPlaceholder = document.getElementById('empty-planner-placeholder');
    plannerGrid.innerHTML = '';
    const today = new Date();
    today.setHours(0,0,0,0);
    
    let isPlanEmpty = true;

    for (let i = 1; i <= 7; i++) {
        const dayIndex = i % 7;
        const currentDay = new Date(startOfWeek);
        currentDay.setDate(startOfWeek.getDate() + (dayIndex - 1 + 7) % 7);

        const dayColumn = document.createElement('div');
        dayColumn.className = 'day-column';
        dayColumn.dataset.dayIndex = dayIndex;

        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header';
        dayHeader.textContent = `${DAY_NAMES[dayIndex]} ${currentDay.getDate()}`;
        if (currentDay.getTime() === today.getTime()) dayHeader.classList.add('today');
        
        const activitiesContainer = document.createElement('div');
        activitiesContainer.className = 'activities-container';

        if (plan[dayIndex] && plan[dayIndex].length > 0) {
            isPlanEmpty = false;
            plan[dayIndex].forEach(activity => {
                const definition = getActivityDefinition(activity);
                const pill = document.createElement('div');
                const classes = ['activity-pill'];
                if (isGoalType(activity.type)) classes.push(activity.type);
                else classes.push('custom-pill');
                pill.className = classes.join(' ');
                pill.dataset.activityId = activity.id;

                if (!isGoalType(activity.type)) {
                    pill.style.background = definition.bg;
                    pill.style.color = definition.color;
                    pill.style.borderColor = definition.border;
                }

                const iconMarkup = definition.icon ? `<i data-lucide="${definition.icon}" class="icon"></i>` : '';
                const labelHTML = `<span class="pill-label">${iconMarkup}<span>${definition.label}</span></span>`;
                let metaText = '';
                if (definition.trackValue) {
                    const planned = formatNumber(activity.plannedValue);
                    const logged = formatNumber(activity.loggedValue);
                    const unitLabel = definition.unit ? ` ${definition.unit}` : '';
                    if (activity.completed) {
                        if (planned) {
                            metaText = `${logged || planned}/${planned}${unitLabel}`;
                        } else {
                            metaText = `${logged || '0'}${unitLabel}`;
                        }
                    } else if (planned) {
                        metaText = `${planned}${unitLabel}`;
                    } else if (definition.unit) {
                        metaText = `Zaloguj w ${definition.unit}`;
                    } else {
                        metaText = 'Dodaj wartość';
                    }
                } else {
                    metaText = activity.completed ? 'Ukończone' : (definition.categoryLabel || 'Do odhaczenia');
                }

                pill.innerHTML = `${labelHTML}${metaText ? `<span class="pill-meta">${metaText}</span>` : ''}`;

                const labelEl = pill.querySelector('.pill-label');
                const metaEl = pill.querySelector('.pill-meta');
                const contentWrap = document.createElement('div');
                contentWrap.className = 'pill-content';
                if (labelEl) contentWrap.appendChild(labelEl);
                if (metaEl) contentWrap.appendChild(metaEl);
                pill.innerHTML = '';
                pill.appendChild(contentWrap);

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-activity-btn';
                deleteBtn.dataset.activityId = activity.id;
                deleteBtn.setAttribute('aria-label', 'Usuń aktywność');
                deleteBtn.innerHTML = `<i data-lucide="x" class="icon" style="width:16px; height:16px;"></i>`;
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    confirmDeleteActivity(activity.id);
                });
                pill.appendChild(deleteBtn);

                if (activity.completed) {
                    pill.classList.add('completed');
                } else {
                    pill.draggable = true;
                }

                pill.addEventListener('dragstart', handleDragStart);
                pill.addEventListener('dragend', handleDragEnd);
                activitiesContainer.appendChild(pill);
            });
        }

        const quickAddBtn = document.createElement('button');
        quickAddBtn.className = 'quick-add-btn';
        quickAddBtn.innerHTML = '<i data-lucide="plus" class="icon" style="width:16px; height:16px;"></i>Dodaj';
        quickAddBtn.setAttribute('aria-label', 'Szybko dodaj aktywność');
        dayColumn.appendChild(quickAddBtn);

        const quickAddMenu = document.createElement('div');
        quickAddMenu.className = 'quick-add-menu';
        for(const type in GOAL_DEFINITIONS) {
            const btn = document.createElement('button');
            btn.innerHTML = `<i data-lucide="${GOAL_DEFINITIONS[type].icon}" class="icon"></i>${GOAL_DEFINITIONS[type].label}`;
            btn.onclick = (e) => {
                e.stopPropagation();
                showPlanModal(type, dayIndex);
                quickAddMenu.style.display = 'none';
            };
            quickAddMenu.appendChild(btn);
        }
        const customBtn = document.createElement('button');
        customBtn.innerHTML = '<i data-lucide="sparkles" class="icon"></i>Własna aktywność';
        customBtn.onclick = (e) => {
            e.stopPropagation();
            showCustomActivityModal(dayIndex);
            quickAddMenu.style.display = 'none';
        };
        quickAddMenu.appendChild(customBtn);
        dayColumn.appendChild(quickAddMenu);

        dayColumn.appendChild(dayHeader);
        dayColumn.appendChild(activitiesContainer);
        dayColumn.addEventListener('dragover', handleDragOver);
        dayColumn.addEventListener('dragleave', handleDragLeave);
        dayColumn.addEventListener('drop', handleDrop);
        plannerGrid.appendChild(dayColumn);
    }
    
    emptyPlaceholder.style.display = isPlanEmpty ? 'block' : 'none';
}

function renderCustomSummary(weekData) {
    const summaryEl = document.getElementById('custom-summary');
    if (!summaryEl) return;
    summaryEl.innerHTML = '';

    const activities = Object.values(weekData.plan).flat().filter(activity => !isGoalType(activity.type));
    const plannedCount = activities.length;
    const completedCount = activities.filter(a => a.completed).length;
    const categories = new Set(activities.map(a => (a.custom?.category || 'other')));
    const valueSum = activities.reduce((total, activity) => {
        const definition = getActivityDefinition(activity);
        if (definition.trackValue) {
            const value = activity.completed ? activity.loggedValue : activity.plannedValue;
            return total + (Number(value) || 0);
        }
        return total;
    }, 0);

    updateCustomCompletionBadge(plannedCount);

    if (!plannedCount) {
        summaryEl.innerHTML = '<div class="empty-state">Nie masz jeszcze własnych aktywności w tym tygodniu. Dodaj pierwszą, aby rozszerzyć swój plan.</div>';
        return;
    }

    const pills = [
        { value: plannedCount, label: 'zaplanowane', style: 'background: rgba(96,165,250,0.16); color: var(--blue);' },
        { value: completedCount, label: 'ukończone', style: 'background: rgba(52,211,153,0.18); color: var(--green);' },
        { value: categories.size, label: 'obszary', style: 'background: rgba(148,163,184,0.16); color: var(--ink);' }
    ];

    if (valueSum > 0) {
        pills.push({ value: formatNumber(valueSum), label: 'łączna wartość', style: 'background: rgba(250,204,21,0.18); color: var(--orange);' });
    }

    pills.forEach(pillData => {
        const pill = document.createElement('div');
        pill.className = 'summary-pill';
        pill.style.cssText = pillData.style;
        const valueSpan = document.createElement('span');
        valueSpan.textContent = pillData.value;
        pill.appendChild(valueSpan);
        pill.append(pillData.label);
        summaryEl.appendChild(pill);
    });
}

function renderCustomTemplates() {
    const listEl = document.getElementById('custom-template-list');
    if (!listEl) return;
    listEl.innerHTML = '';
    const templates = getTemplateCollection();
    if (!templates.length) {
        listEl.innerHTML = '<div class="empty-state">Zapisz wybrane aktywności jako szablony, aby dodawać je w kilka sekund.</div>';
        return;
    }

    templates.forEach(template => {
        const styles = getCategoryStyles(template.category);
        const card = document.createElement('div');
        card.className = 'template-card';

        const meta = document.createElement('div');
        meta.className = 'template-meta';
        meta.innerHTML = `<strong>${template.name}</strong><span class="tiny muted">${styles.label}</span>`;
        if (template.trackType === CUSTOM_TRACK_TYPES.VALUE) {
            const detail = document.createElement('span');
            detail.className = 'tiny muted';
            const unitLabel = template.unit || 'jednostek';
            const plannedText = template.plannedValue ? `${formatNumber(template.plannedValue)} ${unitLabel}` : `dowolna wartość${template.unit ? ` (${template.unit})` : ''}`;
            detail.textContent = `Cel: ${plannedText}`;
            meta.appendChild(detail);
        } else {
            const detail = document.createElement('span');
            detail.className = 'tiny muted';
            detail.textContent = 'Cel: odhaczenie';
            meta.appendChild(detail);
        }

        const actions = document.createElement('div');
        actions.className = 'template-actions';

        const addBtn = document.createElement('button');
        addBtn.className = 'btn soft sm';
        addBtn.innerHTML = '<i data-lucide="plus" class="icon"></i>Dodaj';
        addBtn.onclick = () => showCustomActivityModal(null, template);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn soft sm';
        removeBtn.innerHTML = '<i data-lucide="trash" class="icon"></i>Usuń';
        removeBtn.onclick = () => removeCustomTemplate(template.id);

        actions.appendChild(addBtn);
        actions.appendChild(removeBtn);

        card.appendChild(meta);
        card.appendChild(actions);
        listEl.appendChild(card);
    });
}

function renderWeeklyNotes(weekData) {
    const focusInput = document.getElementById('week-focus-input');
    const highlightInput = document.getElementById('week-highlight-input');
    if (focusInput) focusInput.value = weekData.notes?.focus || '';
    if (highlightInput) highlightInput.value = weekData.notes?.highlight || '';
}

function updateWeekNote(key, value) {
    const [year, week] = getWeekNumber(currentDate);
    initializeWeekData(year, week);
    if (!state[year][week].notes) state[year][week].notes = { focus: '', highlight: '' };
    state[year][week].notes[key] = value;
    clearTimeout(notesSaveTimer);
    notesSaveTimer = setTimeout(() => saveState(), 400);
}

function updateCustomCompletionBadge(count) {
    document.querySelectorAll('[data-role="custom-count"]').forEach(el => {
        el.textContent = count;
    });
}

function renderHeaderKPIs(year) {
    const yearData = state[year] || {};
    const [currentYear, currentWeek] = getWeekNumber(new Date());

    const relevantWeeks = (year < currentYear) ? getWeekNumber(new Date(year, 11, 28))[1] : currentWeek;
    const completedWeeks = Object.keys(yearData).filter(weekNum => parseInt(weekNum) <= relevantWeeks && yearData[weekNum].isComplete).length;

    const percentage = relevantWeeks > 0 ? Math.round((completedWeeks / relevantWeeks) * 100) : 0;
    document.getElementById('yearly-progress-value').innerHTML = `${completedWeeks}/${relevantWeeks} <span class="tiny" style="font-weight: 500;">(${percentage}%)</span>`;

    let currentStreak = 0;
    for (let w = currentWeek; w >= 1; w--) {
        if (state[currentYear]?.[w]?.isComplete) currentStreak++;
        else break;
    }

    let maxStreak = 0, tempStreak = 0;
    getYearKeys().sort().forEach(y => {
        const totalWeeksInYear = getWeekNumber(new Date(y, 11, 28))[1];
        for (let w = 1; w <= totalWeeksInYear; w++) {
            if (state[y]?.[w]?.isComplete) tempStreak++;
            else { maxStreak = Math.max(maxStreak, tempStreak); tempStreak = 0; }
        }
    });
    maxStreak = Math.max(maxStreak, tempStreak);

    document.getElementById('streak-value').innerHTML = `${currentStreak} <span class="tiny" style="font-weight: 500;">(max ${maxStreak})</span>`;
}

function renderPlanningStatus(plan) {
    const statusEl = document.getElementById('planning-status');
    const plannedTotals = {};
    Object.keys(GOAL_DEFINITIONS).forEach(type => plannedTotals[type] = 0);
    Object.values(plan).flat().forEach(activity => {
        if (GOAL_DEFINITIONS[activity.type]) {
            plannedTotals[activity.type] += activity.completed ? activity.loggedValue : (activity.plannedValue || 0);
        }
    });

    const allGoalsPlanned = Object.keys(GOAL_DEFINITIONS).every(type => plannedTotals[type] >= GOAL_DEFINITIONS[type].target);

    if (allGoalsPlanned) {
        statusEl.textContent = '✅ Cele tygodnia zaplanowane!';
        statusEl.style.color = 'var(--green)';
    } else {
        statusEl.textContent = '⚠️ Nie wszystkie cele są w pełni zaplanowane.';
        statusEl.style.color = 'var(--orange)';
    }
}

function renderOverallProgress(progress) {
    let totalPercent = 0;
    for (const type in GOAL_DEFINITIONS) {
        totalPercent += Math.min(100, ((progress[type] || 0) / GOAL_DEFINITIONS[type].target) * 100);
    }
    const avgPercent = totalPercent / Object.keys(GOAL_DEFINITIONS).length;
    const rounded = Math.round(avgPercent);
    const progressBar = document.getElementById('overall-progress-bar');
    if (progressBar) progressBar.style.width = `${avgPercent}%`;
    const progressLabel = document.getElementById('overall-progress-label');
    if (progressLabel) progressLabel.textContent = `Postęp tygodnia: ${rounded}%`;
    const topProgress = document.getElementById('top-week-progress');
    if (topProgress) topProgress.textContent = `${rounded}%`;
}


function renderCopyPlanButton() {
    let prevWeekDate = new Date(currentDate);
    prevWeekDate.setDate(prevWeekDate.getDate() - 7);
    const [prevYear, prevWeek] = getWeekNumber(prevWeekDate);
    
    const prevWeekData = state[prevYear]?.[prevWeek];
    const hasPreviousPlan = prevWeekData && Object.values(prevWeekData.plan).some(day => day.length > 0);
    
    document.getElementById('copy-plan-btn').style.display = hasPreviousPlan ? 'inline-flex' : 'none';
}


// --- MODALE ---
function showModal(config) {
    const modal = document.getElementById('modal-overlay');
    document.getElementById('modal-title').textContent = config.title;
    document.getElementById('modal-text').innerHTML = config.text || '';
    const inputContainer = document.getElementById('modal-input-container');
    const optionsContainer = document.getElementById('modal-options-container');
    inputContainer.innerHTML = '';
    optionsContainer.innerHTML = '';

    if (config.input) {
        const input = document.createElement('input');
        input.type = config.input.type;
        input.placeholder = config.input.placeholder || '';
        input.id = 'modal-input-field';
        input.value = config.input.value || '';
        inputContainer.appendChild(input);
    }

    if (config.options) {
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'modal-options';
        config.options.forEach(opt => {
            const label = document.createElement('label');
            label.className = 'option-label';
            label.innerHTML = `<input type="radio" name="modal-option" value="${opt.value}" ${opt.checked ? 'checked' : ''}> ${opt.label}`;
            optionsDiv.appendChild(label);
        });
        optionsContainer.appendChild(optionsDiv);
    }

    if (config.content) {
        if (typeof config.content === 'function') {
            config.content(inputContainer, optionsContainer);
        } else {
            inputContainer.innerHTML += config.content;
        }
    }

    if (typeof config.onRender === 'function') {
        config.onRender({ inputContainer, optionsContainer, modal });
    }

    const actions = document.getElementById('modal-actions');
    actions.innerHTML = '';
    (config.buttons || []).forEach(btnConfig => {
        const button = document.createElement('button');
        button.textContent = btnConfig.text;
        button.className = btnConfig.class;
        button.onclick = () => {
            if (btnConfig.action === 'close') {
                modal.classList.remove('visible');
            } else {
                const value = inputContainer.querySelector('input')?.value;
                const selectedOption = optionsContainer.querySelector('input:checked')?.value;
                const context = {
                    close: () => modal.classList.remove('visible'),
                    inputContainer,
                    optionsContainer,
                    modal
                };
                const result = btnConfig.action ? btnConfig.action(value, selectedOption, context) : undefined;
                if (result !== false) {
                    modal.classList.remove('visible');
                }
            }
        };
        actions.appendChild(button);
    });
    modal.classList.add('visible');
    if (config.focusSelector) {
        const focusEl = modal.querySelector(config.focusSelector);
        if (focusEl) focusEl.focus();
    } else if (config.input) {
        document.getElementById('modal-input-field').focus();
    }
}

function showPlanModal(type, dayIndex) {
    const goal = GOAL_DEFINITIONS[type];
    if (type === 'gym') { addActivity(type, dayIndex, 1); return; }
    showModal({
        title: `Zaplanuj: ${goal.label}`,
        text: `Ile ${goal.unit} planujesz na ten dzień?`,
        input: { type: 'number', placeholder: '0' },
        buttons: [
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Dodaj plan', class: 'btn', action: (value) => addActivity(type, dayIndex, parseFloat(value) || 0) }
        ]
    });
}

function showCustomActivityModal(dayIndex = null, template = null) {
    const [year, week] = getWeekNumber(currentDate);
    const startOfWeek = getStartOfWeek(year, week);
    const dayOrder = [1, 2, 3, 4, 5, 6, 0];
    let defaultDayIndex = typeof dayIndex === 'number' ? dayIndex : null;
    if (defaultDayIndex === null) {
        const today = new Date();
        const [todayYear, todayWeek] = getWeekNumber(today);
        defaultDayIndex = (todayYear === year && todayWeek === week) ? today.getDay() : 1;
    }
    const initialName = template?.name || '';
    const initialCategory = template?.category || 'body';
    const initialTrackType = template?.trackType || CUSTOM_TRACK_TYPES.CHECK;
    const initialPlannedValue = template?.plannedValue || 0;
    const initialUnit = template?.unit || '';

    showModal({
        title: template ? `Dodaj: ${template.name}` : 'Nowa własna aktywność',
        text: template ? 'Dostosuj szczegóły i przypisz aktywność do wybranego dnia.' : 'Zaplanuj dodatkowe działanie, które wzmocni Twoje cele tygodnia.',
        buttons: [
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Dodaj do planu', class: 'btn', action: (_, __, ctx) => {
                const modalEl = ctx.modal;
                const nameInput = modalEl.querySelector('#custom-activity-name');
                const daySelect = modalEl.querySelector('#custom-activity-day');
                const categorySelect = modalEl.querySelector('#custom-activity-category');
                const trackType = modalEl.querySelector('input[name="custom-track-type"]:checked')?.value || CUSTOM_TRACK_TYPES.CHECK;
                const plannedInput = modalEl.querySelector('#custom-activity-planned');
                const unitInput = modalEl.querySelector('#custom-activity-unit');
                const saveTemplateCheckbox = modalEl.querySelector('#custom-activity-save-template');

                const name = nameInput.value.trim();
                if (!name) {
                    nameInput.classList.add('input-error');
                    nameInput.focus();
                    return false;
                }

                const selectedDay = parseInt(daySelect.value, 10);
                let plannedValue = trackType === CUSTOM_TRACK_TYPES.VALUE ? parseFloat(plannedInput.value) : 1;
                if (Number.isNaN(plannedValue) || plannedValue < 0) plannedValue = 0;
                const unit = trackType === CUSTOM_TRACK_TYPES.VALUE ? (unitInput.value.trim() || 'jednostek') : '';
                const category = categorySelect.value;
                const styles = getCategoryStyles(category);

                const customPayload = {
                    name,
                    category,
                    unit,
                    icon: styles.icon,
                    color: styles.color,
                    bg: styles.bg,
                    border: styles.border,
                    trackType
                };

                if (saveTemplateCheckbox?.checked) {
                    const templatePayload = {
                        id: template?.id || `tpl_${Date.now()}_${Math.random()}`,
                        name,
                        category,
                        trackType,
                        unit,
                        plannedValue: trackType === CUSTOM_TRACK_TYPES.VALUE ? plannedValue : 1
                    };
                    saveCustomTemplate(templatePayload, { deferSave: true, replace: Boolean(template?.id) });
                }

                addActivity('custom', selectedDay, trackType === CUSTOM_TRACK_TYPES.VALUE ? plannedValue : 1, { custom: customPayload });
            }}
        ],
        onRender: ({ inputContainer }) => {
            const form = document.createElement('div');
            form.className = 'custom-activity-form';
            form.innerHTML = `
                <div class="form-group">
                    <label for="custom-activity-name">Nazwa aktywności</label>
                    <input type="text" id="custom-activity-name" placeholder="Np. Trening brzucha, medytacja, spacer" />
                </div>
                <div class="inline-fields">
                    <div class="form-group">
                        <label for="custom-activity-day">Dzień</label>
                        <select id="custom-activity-day"></select>
                        <span class="helper">Możesz później przeciągnąć aktywność do innego dnia.</span>
                    </div>
                    <div class="form-group">
                        <label for="custom-activity-category">Obszar</label>
                        <select id="custom-activity-category"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Jak chcesz monitorować?</label>
                    <div class="radio-group">
                        <label class="radio-chip"><input type="radio" name="custom-track-type" value="${CUSTOM_TRACK_TYPES.CHECK}" checked> Odhaczenie</label>
                        <label class="radio-chip"><input type="radio" name="custom-track-type" value="${CUSTOM_TRACK_TYPES.VALUE}"> Wartość liczbowa</label>
                    </div>
                    <div id="custom-track-value-fields" class="inline-fields" style="display:none;">
                        <div class="form-group">
                            <label for="custom-activity-planned">Planowana wartość</label>
                            <input type="number" id="custom-activity-planned" min="0" step="0.5" placeholder="Np. 30" />
                        </div>
                        <div class="form-group">
                            <label for="custom-activity-unit">Jednostka</label>
                            <input type="text" id="custom-activity-unit" placeholder="min, powtórzeń, stron..." />
                        </div>
                    </div>
                </div>
                <label class="checkbox-line"><input type="checkbox" id="custom-activity-save-template">Zapisz jako szablon na przyszłość</label>
            `;
            inputContainer.appendChild(form);

            const daySelect = form.querySelector('#custom-activity-day');
            dayOrder.forEach(idx => {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + (idx - 1 + 7) % 7);
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${DAY_NAMES[idx]} ${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                daySelect.appendChild(option);
            });
            daySelect.value = defaultDayIndex;

            const categorySelect = form.querySelector('#custom-activity-category');
            Object.entries(CUSTOM_ACTIVITY_CATEGORIES).forEach(([key, value]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value.label;
                categorySelect.appendChild(option);
            });
            categorySelect.value = initialCategory;

            const trackRadios = form.querySelectorAll('input[name="custom-track-type"]');
            const valueFields = form.querySelector('#custom-track-value-fields');
            const plannedInput = form.querySelector('#custom-activity-planned');
            const unitInput = form.querySelector('#custom-activity-unit');

            const toggleValueFields = () => {
                const selected = form.querySelector('input[name="custom-track-type"]:checked')?.value;
                if (selected === CUSTOM_TRACK_TYPES.VALUE) {
                    valueFields.style.display = 'grid';
                } else {
                    valueFields.style.display = 'none';
                }
            };
            trackRadios.forEach(radio => radio.addEventListener('change', toggleValueFields));

            const nameField = form.querySelector('#custom-activity-name');
            nameField.value = initialName;
            nameField.addEventListener('input', () => nameField.classList.remove('input-error'));
            form.querySelector(`input[name="custom-track-type"][value="${initialTrackType}"]`).checked = true;
            plannedInput.value = initialTrackType === CUSTOM_TRACK_TYPES.VALUE ? (initialPlannedValue || '') : '';
            unitInput.value = initialTrackType === CUSTOM_TRACK_TYPES.VALUE ? initialUnit : '';
            toggleValueFields();

            if (template) {
                form.querySelector('#custom-activity-save-template').checked = false;
            }
        },
        focusSelector: '#custom-activity-name'
    });
}

function saveCustomTemplate(template, options = {}) {
    const { deferSave = false, replace = false } = options;
    const templates = getTemplateCollection().slice();
    if (replace) {
        const index = templates.findIndex(t => t.id === template.id);
        if (index !== -1) templates[index] = template;
        else templates.push(template);
    } else {
        templates.push(template);
    }
    setTemplateCollection(templates);
    if (!deferSave) {
        saveState();
        renderCustomTemplates();
        lucide.createIcons();
    }
}

function removeCustomTemplate(templateId) {
    const templates = getTemplateCollection().filter(t => t.id !== templateId);
    setTemplateCollection(templates);
    saveState();
    render();
}

function showLogModal(activity) {
    const { id } = activity;
    const definition = getActivityDefinition(activity);
    if (!definition.trackValue) {
        const valueToLog = Number(activity.plannedValue) || 1;
        logActivity(id, valueToLog, true);
        return;
    }
    showModal({
        title: `Loguj: ${definition.label}`,
        text: definition.unit ? `Wprowadź ile ${definition.unit} udało Ci się zrobić:` : 'Wprowadź wartość, aby odnotować postęp:',
        input: { type: 'number', placeholder: activity.plannedValue || '0', value: activity.loggedValue || activity.plannedValue || '' },
        buttons: [
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Zapisz', class: 'btn', action: (value) => logActivity(id, parseFloat(value) || 0, true) }
        ]
    });
}

function showEditLogModal(activity) {
    const { id, loggedValue } = activity;
    const definition = getActivityDefinition(activity);
    if (!definition.trackValue) {
        showModal({
            title: `Edytuj: ${definition.label}`,
            text: 'Ta aktywność jest ukończona. Możesz cofnąć jej zaliczenie.',
            buttons: [
                { text: 'Cofnij ukończenie', class: 'btn danger', action: () => logActivity(id, 0, false) },
                { text: 'Zamknij', class: 'btn soft', action: 'close' }
            ]
        });
        return;
    }
    showModal({
        title: `Edytuj: ${definition.label}`,
        text: definition.unit ? `Zaktualizuj, ile ${definition.unit} udało Ci się zrobić:` : 'Zaktualizuj wartość postępu:',
        input: { type: 'number', placeholder: '0', value: loggedValue },
        buttons: [
            { text: 'Cofnij ukończenie', class: 'btn danger', action: () => logActivity(id, 0, false) },
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Zapisz', class: 'btn', action: (value) => logActivity(id, parseFloat(value) || 0, true) }
        ]
    });
}

function showCopyPlanModal() {
    showModal({
        title: 'Kopiuj plan z poprzedniego tygodnia',
        text: 'Wybierz, co chcesz skopiować do bieżącego tygodnia:',
        options: [
            { value: 'planOnly', label: 'Tylko plan (bez ukończonych zadań)', checked: true },
            { value: 'planAndProgress', label: 'Plan wraz z postępem' }
        ],
        buttons: [
            { text: 'Anuluj', class: 'btn soft', action: 'close' },
            { text: 'Kopiuj', class: 'btn', action: (_, selectedOption) => {
                copyPreviousWeek(selectedOption === 'planAndProgress');
            }}
        ]
    });
}

function showWeeklySummary() {
    const today = new Date();
    if (today.getDay() !== 1) return; // Uruchom tylko w poniedziałki

    const lastWeekDate = new Date();
    lastWeekDate.setDate(today.getDate() - 1);
    const [year, week] = getWeekNumber(lastWeekDate);
    const weekData = state[year]?.[week];

    if (weekData && !weekData.summaryShown) {
        let summaryText = `W zeszłym tygodniu udało Ci się:<br><br>`;
        Object.keys(GOAL_DEFINITIONS).forEach(type => {
            const progress = weekData.progress[type] || 0;
            const target = GOAL_DEFINITIONS[type].target;
            summaryText += `<b>${GOAL_DEFINITIONS[type].label}:</b> ${progress.toLocaleString('pl-PL')}/${target.toLocaleString('pl-PL')} ${GOAL_DEFINITIONS[type].unit}<br>`;
        });
        summaryText += `<br>${weekData.isComplete ? 'Świetna robota! Osiągnąłeś wszystkie cele.' : 'Dobra robota! Tak trzymaj.'}`;

        showModal({
            title: `Podsumowanie tygodnia ${week}`,
            text: summaryText,
            buttons: [{ text: 'OK', class: 'btn', action: 'close' }]
        });
        weekData.summaryShown = true;
        saveState();
    }
}


// --- OBSŁUGA ZDARZEŃ ---
function handleDragStart(e) {
    dragState.activityId = e.target.closest('.activity-pill').dataset.activityId;
    dragState.sourceDay = e.target.closest('.day-column').dataset.dayIndex;
    setTimeout(() => e.target.closest('.activity-pill').classList.add('dragging'), 0);
}
function handleDragEnd(e) {
    const pill = document.querySelector('.activity-pill.dragging');
    if(pill) pill.classList.remove('dragging');
}
function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const targetDayIndex = parseInt(e.currentTarget.dataset.dayIndex);
    const sourceDayIndex = parseInt(dragState.sourceDay);
    if (targetDayIndex === sourceDayIndex) return;

    const [year, week] = getWeekNumber(currentDate);
    const weekData = state[year][week];
    const activityIndex = weekData.plan[sourceDayIndex].findIndex(a => a.id === dragState.activityId);
    if (activityIndex === -1) return;

    const [activity] = weekData.plan[sourceDayIndex].splice(activityIndex, 1);
    activity.day = targetDayIndex;
    
    if(!weekData.plan[targetDayIndex]) weekData.plan[targetDayIndex] = [];
    weekData.plan[targetDayIndex].push(activity);
    saveState();
    render();
}

function setupEventListeners() {
    document.getElementById('prev-week-btn').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 7); render(); });
    document.getElementById('next-week-btn').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 7); render(); });
    document.getElementById('today-week-btn').addEventListener('click', () => { currentDate = new Date(); render(); });
    document.getElementById('copy-plan-btn').addEventListener('click', showCopyPlanModal);
    document.getElementById('add-custom-activity-btn').addEventListener('click', () => showCustomActivityModal());
    const plannerPanel = document.getElementById('tab-content-planner');
    const statsPanel = document.getElementById('tab-content-stats');

    const activateTab = (tabName) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
        if (plannerPanel) plannerPanel.classList.toggle('active', tabName === 'planner');
        if (statsPanel) statsPanel.classList.toggle('active', tabName === 'stats');
        if (tabName === 'stats') renderStats();
    };

    document.getElementById('jump-to-planner').addEventListener('click', () => {
        activateTab('planner');
        plannerPanel?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    const focusInput = document.getElementById('week-focus-input');
    const highlightInput = document.getElementById('week-highlight-input');
    focusInput.addEventListener('input', (e) => updateWeekNote('focus', e.target.value));
    highlightInput.addEventListener('input', (e) => updateWeekNote('highlight', e.target.value));

    document.querySelectorAll('[data-action="plan"]').forEach(btn => {
        btn.addEventListener('click', (e) => startPlanning(e.currentTarget.dataset.activityType));
    });
    
    document.querySelector('.planner-grid').addEventListener('click', (e) => {
        const dayColumn = e.target.closest('.day-column');
        if (!dayColumn) return;
        const dayIndex = parseInt(dayColumn.dataset.dayIndex, 10);
        
        if (planningState.isPlanning) {
            if (!e.target.closest('.activity-pill') && !e.target.closest('.quick-add-btn')) {
                showPlanModal(planningState.activityType, dayIndex);
            }
            return;
        }

        if (e.target.closest('.quick-add-btn')) {
            const menu = dayColumn.querySelector('.quick-add-menu');
            document.querySelectorAll('.quick-add-menu').forEach(m => {
                if(m !== menu) m.style.display = 'none';
            });
            menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
            e.stopPropagation();
            return;
        }

        const deleteBtn = e.target.closest('.delete-activity-btn');
        if (deleteBtn) {
            confirmDeleteActivity(deleteBtn.dataset.activityId);
            return;
        }
        
        const pill = e.target.closest('.activity-pill');
        if (pill) {
            const activityId = pill.dataset.activityId;
            const [year, week] = getWeekNumber(currentDate);
            const activity = state[year]?.[week]?.plan?.[dayIndex]?.find(a => a.id === activityId);

            if (activity) {
                if (activity.completed) {
                    showEditLogModal(activity);
                } else {
                    const definition = getActivityDefinition(activity);
                    if (!definition.trackValue) {
                        const valueToLog = Number(activity.plannedValue) || 1;
                        logActivity(activityId, valueToLog, true);
                    } else {
                        showLogModal(activity);
                    }
                }
            }
        }
    });

    document.addEventListener('click', e => {
        if (!e.target.closest('.day-column')) {
            document.querySelectorAll('.quick-add-menu').forEach(menu => menu.style.display = 'none');
        }
    });

    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => activateTab(e.currentTarget.dataset.tab));
    });

    const initialTab = document.querySelector('.tab.active')?.dataset.tab || 'planner';
    activateTab(initialTab);

    document.getElementById('cancel-planning-btn').addEventListener('click', stopPlanning);
}


// --- INICJALIZACJA ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    render();
    setupEventListeners();
    showWeeklySummary();
});

// --- STATYSTYKI ---
function renderStats() {
    const statsTotalEl = document.getElementById('stats-total-activities');
    const statsRateEl = document.getElementById('stats-completion-rate');
    const statsGoalPerformanceEl = document.getElementById('stats-goal-performance');
    const statsGoalSummaryEl = document.getElementById('stats-goal-summary');
    const statsCustomCountEl = document.getElementById('stats-custom-activities');
    const statsCustomValueEl = document.getElementById('stats-custom-value');
    const goalContainer = document.getElementById('stats-goal-breakdown');
    const categoryContainer = document.getElementById('stats-top-categories');
    const recentList = document.getElementById('stats-recent-list');
    const monthlyContainer = document.getElementById('stats-monthly-bars');
    const heatmapContainer = document.querySelector('.heatmap-container');
    const weekTrendContainer = document.getElementById('stats-week-trend');
    const weekdayContainer = document.getElementById('stats-weekday-chart');
    const topActivitiesList = document.getElementById('stats-top-activities');

    if (!statsTotalEl && !statsRateEl && !goalContainer && !categoryContainer && !recentList && !monthlyContainer && !heatmapContainer && !weekTrendContainer && !weekdayContainer && !topActivitiesList) {
        return;
    }

    const allActivities = [];
    const completedActivities = [];
    const categorySummary = {};
    const monthlySummary = {};
    const goalAggregate = {};
    const trackedWeeks = new Set();
    const weekRecords = [];
    const dayAggregate = { 0: { completed: 0, total: 0 }, 1: { completed: 0, total: 0 }, 2: { completed: 0, total: 0 }, 3: { completed: 0, total: 0 }, 4: { completed: 0, total: 0 }, 5: { completed: 0, total: 0 }, 6: { completed: 0, total: 0 } };
    const activityFrequency = {};

    Object.keys(GOAL_DEFINITIONS).forEach(type => {
        goalAggregate[type] = { actual: 0, raw: 0, target: 0, weeks: 0 };
    });

    const yearKeys = getYearKeys().sort();
    yearKeys.forEach(yearKey => {
        const weeks = state[yearKey] || {};
        Object.keys(weeks).forEach(weekKey => {
            const weekData = weeks[weekKey];
            const yearValue = parseInt(yearKey, 10);
            const weekValue = parseInt(weekKey, 10);
            const startOfWeek = getStartOfWeek(yearValue, weekValue);
            const hasGoalPlan = Object.values(weekData.plan || {}).some(arr => arr.some(activity => isGoalType(activity.type)));
            if (hasGoalPlan) {
                trackedWeeks.add(`${yearValue}-${weekValue}`);
                Object.keys(GOAL_DEFINITIONS).forEach(type => {
                    const progressValue = Number(weekData.progress?.[type] || 0);
                    goalAggregate[type].actual += Math.min(progressValue, GOAL_DEFINITIONS[type].target);
                    goalAggregate[type].raw += progressValue;
                    goalAggregate[type].target += GOAL_DEFINITIONS[type].target;
                    goalAggregate[type].weeks += 1;
                });
            }

            let plannedForWeek = 0;
            let completedForWeek = 0;

            Object.entries(weekData.plan || {}).forEach(([dayKey, dayActivities]) => {
                const dayIndex = parseInt(dayKey, 10);
                const activityDate = new Date(startOfWeek);
                activityDate.setDate(startOfWeek.getDate() + (dayIndex - 1 + 7) % 7);
                dayActivities.forEach(activity => {
                    plannedForWeek += 1;
                    if (activity.completed) completedForWeek += 1;
                    const entry = { ...activity, year: yearValue, week: weekValue, dayIndex, date: activityDate };
                    allActivities.push(entry);
                    if (activity.completed) completedActivities.push(entry);

                    const monthKey = `${activityDate.getFullYear()}-${String(activityDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlySummary[monthKey]) monthlySummary[monthKey] = { total: 0, completed: 0 };
                    monthlySummary[monthKey].total += 1;
                    if (activity.completed) monthlySummary[monthKey].completed += 1;

                    const dayStats = dayAggregate[dayIndex] || (dayAggregate[dayIndex] = { completed: 0, total: 0 });
                    dayStats.total += 1;
                    if (activity.completed) dayStats.completed += 1;

                    const definition = getActivityDefinition(activity);
                    const freqKey = `${definition.label}|${definition.categoryLabel || 'Cel tygodnia'}`;
                    if (!activityFrequency[freqKey]) {
                        activityFrequency[freqKey] = {
                            label: definition.label,
                            category: definition.categoryLabel || 'Cel tygodnia',
                            color: definition.color || 'var(--accent)',
                            total: 0,
                            completed: 0
                        };
                    }
                    activityFrequency[freqKey].total += 1;
                    if (activity.completed) activityFrequency[freqKey].completed += 1;

                    if (!isGoalType(activity.type)) {
                        const categoryKey = activity.custom?.category || 'other';
                        if (!categorySummary[categoryKey]) {
                            const styles = getCategoryStyles(categoryKey);
                            categorySummary[categoryKey] = { label: styles.label, color: styles.color, count: 0, completed: 0 };
                        }
                        categorySummary[categoryKey].count += 1;
                        if (activity.completed) categorySummary[categoryKey].completed += 1;
                    }
                });
            });

            weekRecords.push({ year: yearValue, week: weekValue, start: startOfWeek, data: weekData, planned: plannedForWeek, completed: completedForWeek });
        });
    });

    allActivities.sort((a, b) => a.date - b.date);
    completedActivities.sort((a, b) => b.date - a.date);

    const totalActivities = allActivities.length;
    const totalCompleted = completedActivities.length;
    const completionRate = totalActivities ? Math.round((totalCompleted / totalActivities) * 100) : 0;
    if (statsTotalEl) statsTotalEl.textContent = totalActivities;
    if (statsRateEl) statsRateEl.textContent = totalActivities ? `${totalCompleted} ukończonych (${completionRate}%)` : 'Brak danych';

    const customCount = allActivities.filter(activity => !isGoalType(activity.type)).length;
    if (statsCustomCountEl) statsCustomCountEl.textContent = customCount;
    const customValue = allActivities.reduce((sum, activity) => {
        if (!isGoalType(activity.type) && activity.completed) {
            const logged = Number(activity.loggedValue);
            if (!Number.isNaN(logged)) return sum + logged;
        }
        return sum;
    }, 0);
    if (statsCustomValueEl) statsCustomValueEl.textContent = customValue ? `Łączna wartość: ${formatNumber(customValue)}` : 'Łączna wartość: 0';

    let aggregatedPercent = 0;
    let goalCounter = 0;
    if (goalContainer) goalContainer.innerHTML = '';
    Object.keys(GOAL_DEFINITIONS).forEach(type => {
        const data = goalAggregate[type];
        if (!data || !data.target) return;
        goalCounter++;
        const def = GOAL_DEFINITIONS[type];
        const percent = Math.min(100, Math.round((data.actual / data.target) * 100));
        aggregatedPercent += percent;
        if (goalContainer) {
            const avg = data.weeks ? Math.round(data.raw / data.weeks) : 0;
            const wrapper = document.createElement('div');
            wrapper.className = 'goal-progress-bar';
            wrapper.innerHTML = `
                <div class="goal-progress-head"><span>${def.label}</span><span>${percent}%</span></div>
                <div class="goal-progress-track"><span style="width:${percent}%; background:${def.color};"></span></div>
                <span class="tiny muted">Średnio ${formatNumber(avg)}/${formatNumber(def.target)} ${def.unit || ''} na tydzień</span>
            `;
            goalContainer.appendChild(wrapper);
        }
    });
    if (goalContainer && !goalContainer.children.length) {
        goalContainer.innerHTML = '<div class="empty-state small">Brak zaplanowanych celów do analizy.</div>';
    }
    if (statsGoalPerformanceEl) {
        const averagePercent = goalCounter ? Math.round(aggregatedPercent / goalCounter) : 0;
        statsGoalPerformanceEl.textContent = `${averagePercent}%`;
    }
    if (statsGoalSummaryEl) {
        statsGoalSummaryEl.textContent = trackedWeeks.size ? `${trackedWeeks.size} tyg. w historii` : 'Brak tygodni';
    }

    if (categoryContainer) {
        categoryContainer.innerHTML = '';
        const categories = Object.entries(categorySummary).sort(([, a], [, b]) => (b.completed - a.completed) || (b.count - a.count));
        if (!categories.length) {
            const empty = document.createElement('div');
            empty.className = 'empty-state small';
            empty.style.width = '100%';
            empty.textContent = 'Dodaj własne aktywności, aby zobaczyć ich rozkład.';
            categoryContainer.appendChild(empty);
        } else {
            categories.forEach(([, data]) => {
                const completion = data.count ? Math.round((data.completed / data.count) * 100) : 0;
                const pill = document.createElement('span');
                pill.className = 'category-pill';
                pill.style.border = `1px solid ${data.color}`;
                pill.style.color = data.color;
                pill.style.background = 'rgba(15, 23, 42, 0.55)';
                pill.innerHTML = `${data.label}<span>${data.completed}/${data.count} (${completion}%)</span>`;
                categoryContainer.appendChild(pill);
            });
        }
    }

    if (recentList) {
        recentList.innerHTML = '';
        if (!completedActivities.length) {
            const empty = document.createElement('li');
            empty.className = 'empty-state small';
            empty.textContent = 'Brak ukończonych aktywności.';
            recentList.appendChild(empty);
        } else {
            completedActivities.slice(0, 5).forEach(activity => {
                const definition = getActivityDefinition(activity);
                const item = document.createElement('li');
                const meta = document.createElement('div');
                meta.className = 'recent-meta';
                const title = document.createElement('strong');
                title.textContent = definition.label;
                const subtitle = document.createElement('span');
                subtitle.className = 'tiny muted';
                subtitle.textContent = `${activity.date.toLocaleDateString('pl-PL', { weekday: 'short', day: '2-digit', month: 'short' })} • ${definition.categoryLabel || 'Cel tygodnia'}`;
                meta.appendChild(title);
                meta.appendChild(subtitle);
                const value = document.createElement('span');
                value.className = 'recent-value';
                if (definition.trackValue) {
                    const loggedValue = Number(activity.loggedValue || activity.plannedValue || 0);
                    const unitLabel = definition.unit ? ` ${definition.unit}` : '';
                    value.textContent = `+${formatNumber(loggedValue)}${unitLabel}`;
                } else {
                    value.textContent = '✔︎';
                }
                item.appendChild(meta);
                item.appendChild(value);
                recentList.appendChild(item);
            });
        }
    }

    if (monthlyContainer) {
        monthlyContainer.innerHTML = '';
        const months = Object.keys(monthlySummary).sort();
        const displayMonths = months.slice(-6);
        if (!displayMonths.length) {
            const empty = document.createElement('div');
            empty.className = 'empty-state small';
            empty.style.width = '100%';
            empty.textContent = 'Brak danych miesięcznych.';
            monthlyContainer.appendChild(empty);
        } else {
            displayMonths.forEach(key => {
                const [yearValue, monthValue] = key.split('-').map(Number);
                const label = new Date(yearValue, monthValue - 1, 1).toLocaleDateString('pl-PL', { month: 'short' });
                const { total, completed } = monthlySummary[key];
                const percentRaw = total ? Math.round((completed / total) * 100) : 0;
                const percent = Math.min(100, Math.max(percentRaw, 0));
                const bar = document.createElement('div');
                bar.className = 'monthly-bar';
                const fill = document.createElement('div');
                fill.className = 'monthly-bar-fill';
                fill.style.height = `${Math.max(percent, total ? 6 : 2)}%`;
                fill.innerHTML = `<span>${percent}%</span>`;
                const labelEl = document.createElement('strong');
                labelEl.textContent = label;
                const summaryEl = document.createElement('small');
                summaryEl.className = 'tiny';
                summaryEl.textContent = `${completed}/${total}`;
                bar.appendChild(fill);
                bar.appendChild(labelEl);
                bar.appendChild(summaryEl);
                monthlyContainer.appendChild(bar);
            });
        }
    }

    if (weekTrendContainer) {
        weekTrendContainer.innerHTML = '';
        const sortedWeeks = weekRecords.slice().sort((a, b) => a.start - b.start).slice(-6).reverse();
        if (!sortedWeeks.length) {
            weekTrendContainer.innerHTML = '<div class="empty-state small">Brak tygodni w historii.</div>';
        } else {
            sortedWeeks.forEach(record => {
                const row = document.createElement('div');
                row.className = 'trend-row';
                const info = document.createElement('div');
                info.className = 'trend-info';
                const label = document.createElement('strong');
                label.textContent = `Tydz ${record.week}`;
                const range = document.createElement('span');
                range.className = 'tiny muted';
                range.textContent = record.start.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
                info.appendChild(label);
                info.appendChild(range);
                const focusNote = record.data?.notes?.focus?.trim();
                if (focusNote) {
                    const focus = document.createElement('span');
                    focus.className = 'trend-focus';
                    focus.textContent = focusNote.length > 60 ? `${focusNote.slice(0, 57)}…` : focusNote;
                    info.appendChild(focus);
                }
                const progressWrap = document.createElement('div');
                progressWrap.className = 'trend-progress';
                let percentSum = 0;
                let goalCount = 0;
                Object.keys(GOAL_DEFINITIONS).forEach(type => {
                    const target = GOAL_DEFINITIONS[type].target;
                    if (!target) return;
                    goalCount++;
                    const value = Number(record.data?.progress?.[type] || 0);
                    percentSum += Math.min(100, Math.round((value / target) * 100));
                });
                const goalPercent = goalCount ? Math.round(percentSum / goalCount) : 0;
                progressWrap.innerHTML = `
                    <div class="trend-bar"><span style="width:${goalPercent}%"></span></div>
                    <span class="tiny muted">${record.completed}/${record.planned} aktywności</span>
                `;
                row.appendChild(info);
                row.appendChild(progressWrap);
                weekTrendContainer.appendChild(row);
            });
        }
    }

    if (weekdayContainer) {
        weekdayContainer.innerHTML = '';
        const dayOrder = [1, 2, 3, 4, 5, 6, 0];
        const hasData = dayOrder.some(day => (dayAggregate[day]?.total || 0) > 0);
        if (!hasData) {
            weekdayContainer.innerHTML = '<div class="empty-state small">Brak danych dziennych.</div>';
        } else {
            dayOrder.forEach(day => {
                const stats = dayAggregate[day] || { completed: 0, total: 0 };
                const percent = stats.total ? Math.round((stats.completed / stats.total) * 100) : 0;
                const row = document.createElement('div');
                row.className = 'weekday-item';
                row.innerHTML = `
                    <span class="tiny muted">${DAY_NAMES[day]}</span>
                    <div class="weekday-track" data-label="${percent}%"><span style="width:${percent}%"></span></div>
                    <span class="tiny muted">${stats.completed}/${stats.total}</span>
                `;
                weekdayContainer.appendChild(row);
            });
        }
    }

    if (topActivitiesList) {
        topActivitiesList.innerHTML = '';
        const topActivities = Object.values(activityFrequency).sort((a, b) => (b.completed - a.completed) || (b.total - a.total)).slice(0, 5);
        if (!topActivities.length) {
            const empty = document.createElement('li');
            empty.className = 'empty-state small';
            empty.textContent = 'Zrealizuj kilka zadań, aby zobaczyć ranking.';
            topActivitiesList.appendChild(empty);
        } else {
            topActivities.forEach(item => {
                const li = document.createElement('li');
                const meta = document.createElement('div');
                meta.style.display = 'grid';
                meta.style.gap = '2px';
                const title = document.createElement('strong');
                title.textContent = item.label;
                const subtitle = document.createElement('span');
                subtitle.textContent = item.category;
                meta.appendChild(title);
                meta.appendChild(subtitle);
                const value = document.createElement('span');
                value.className = 'recent-value';
                value.style.color = item.color;
                value.textContent = `${item.completed}/${item.total}`;
                li.appendChild(meta);
                li.appendChild(value);
                topActivitiesList.appendChild(li);
            });
        }
    }

    if (heatmapContainer) {
        heatmapContainer.innerHTML = '';
        const currentYear = getWeekNumber(currentDate)[0];
        const yearData = state[currentYear] || {};
        const activitiesByDay = {};
        Object.keys(yearData).forEach(week => {
            Object.keys(yearData[week].plan).forEach(day => {
                const dayActivities = yearData[week].plan[day];
                if (dayActivities.length > 0) {
                    const date = new Date(getStartOfWeek(currentYear, parseInt(week, 10)));
                    date.setDate(date.getDate() + (parseInt(day, 10) - 1 + 7) % 7);
                    const dateString = toYYYYMMDD(date);
                    activitiesByDay[dateString] = (activitiesByDay[dateString] || 0) + dayActivities.filter(a => a.completed).length;
                }
            });
        });

        const firstDayOfYear = new Date(currentYear, 0, 1);
        let currentDay = new Date(firstDayOfYear);
        currentDay.setDate(currentDay.getDate() - (currentDay.getDay() - 1 + 7) % 7);

        const heatmap = document.createElement('div');
        heatmap.className = 'heatmap';

        let hasHeatmapActivity = false;
        for (let i = 0; i < 53 * 7; i++) {
            const dateString = toYYYYMMDD(currentDay);
            const cell = document.createElement('div');
            cell.className = 'heatmap-cell';

            if (currentDay.getFullYear() === currentYear) {
                const count = activitiesByDay[dateString] || 0;
                let level = 0;
                if (count > 0) level = 1;
                if (count > 1) level = 2;
                if (count > 2) level = 3;
                if (count > 3) level = 4;
                cell.dataset.level = level;
                cell.title = `${dateString}: ${count} ukończone aktywności`;
                if (count > 0) hasHeatmapActivity = true;
            } else {
                cell.style.background = 'transparent';
            }
            heatmap.appendChild(cell);
            currentDay.setDate(currentDay.getDate() + 1);
        }
        if (!hasHeatmapActivity) {
            const empty = document.createElement('div');
            empty.className = 'empty-state small';
            empty.textContent = 'Brak ukończonych aktywności w bieżącym roku.';
            empty.style.marginBottom = '12px';
            heatmapContainer.appendChild(empty);
        }
        heatmapContainer.appendChild(heatmap);
    }

    lucide.createIcons();
}


// --- TRYB PLANOWANIA ---
function startPlanning(type) {
    planningState = { isPlanning: true, activityType: type };
    document.getElementById('tab-content-planner').classList.add('planning-mode');
    document.getElementById('planning-instructions').style.display = 'block';
    document.getElementById('planning-instructions').textContent = `Kliknij w wybrany dzień, aby dodać: ${GOAL_DEFINITIONS[type].label}`;
    document.getElementById('cancel-planning-btn').style.display = 'inline-flex';
    document.querySelectorAll('[data-action="plan"]').forEach(b => b.style.display = 'none');
}

function stopPlanning() {
    planningState = { isPlanning: false, activityType: null };
    document.getElementById('tab-content-planner').classList.remove('planning-mode');
    document.getElementById('planning-instructions').style.display = 'none';
    document.getElementById('cancel-planning-btn').style.display = 'none';
    document.querySelectorAll('[data-action="plan"]').forEach(b => b.style.display = 'inline-flex');
}

</script>
</body>
</html>

