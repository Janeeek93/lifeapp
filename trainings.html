<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeOS – Trainings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
:root {
  --bg: #eef2ff;
  --bg-alt: #f8fafc;
  --card: #ffffff;
  --ink: #0f172a;
  --muted: #64748b;
  --line: #e2e8f0;
  --primary: #2563eb;
  --primary-soft: #eff6ff;
  --primary-border: #bfdbfe;
  --success: #0f9d58;
  --success-soft: #ecfdf5;
  --success-border: #bbf7d0;
  --warning: #f59e0b;
  --danger: #dc2626;
  --shadow-sm: 0 12px 30px rgba(15, 23, 42, 0.08);
  --shadow-lg: 0 28px 60px rgba(15, 23, 42, 0.12);
  --transition: all .2s ease;
  --gym-color: #5b21b6;
  --run-color: #047857;
  --read-color: #1d4ed8;
  --extra-color: #0ea5e9;
  --day-empty: #fff1f2;
  --day-empty-border: rgba(248, 113, 113, 0.5);
  --day-planned: #fff7ed;
  --day-planned-border: rgba(251, 191, 36, 0.45);
  --day-completed: #ecfdf5;
  --day-completed-border: rgba(34, 197, 94, 0.45);
}

*, *::before, *::after { box-sizing: border-box; }
body {
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(160deg, #e0e7ff 0%, #f1f5f9 45%, #ffffff 100%);
  color: var(--ink);
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto;
  font-size: 13px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

h1, h2, h3, h4, h5 { margin: 0; color: var(--ink); }
p { margin: 0; }

.wrap {
  max-width: 1280px;
  margin: 0 auto;
  padding: 28px 32px 40px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

a { color: inherit; text-decoration: none; }

.card {
  background: var(--card);
  border-radius: 20px;
  border: 1px solid rgba(148, 163, 184, 0.25);
  padding: 20px 24px;
  box-shadow: var(--shadow-sm);
}

.page-header {
  display: flex;
  flex-direction: column;
  gap: 18px;
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(12px);
}

.page-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.title-block { display: flex; flex-direction: column; gap: 6px; }
.eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.14em;
  font-size: 10px;
  font-weight: 600;
  color: var(--muted);
}

.title-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.title-row h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.3px; }

.page-header-actions { display: flex; gap: 10px; align-items: center; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 12px;
  border: 1px solid transparent;
  background: var(--ink);
  color: #fff;
  cursor: pointer;
  transition: var(--transition);
}

.btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.btn .icon { width: 16px; height: 16px; }
.btn.soft { background: #fff; color: var(--ink); border-color: rgba(148, 163, 184, 0.45); }
.btn.soft:hover { border-color: var(--primary); color: var(--primary); }
.btn.ghost { background: rgba(148, 163, 184, 0.16); color: var(--ink); }
.btn.ghost:hover { background: rgba(148, 163, 184, 0.3); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

.icon-btn {
  width: 38px;
  height: 38px;
  border-radius: 12px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: #fff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  color: var(--ink);
}

.icon-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); box-shadow: var(--shadow-sm); }

.icon { width: 16px; height: 16px; }

.month-bar { display: flex; justify-content: space-between; align-items: center; }
.month-controls { display: flex; align-items: center; gap: 12px; }
.month-labels { display: flex; flex-direction: column; gap: 4px; align-items: center; }
.month-labels h2 { font-size: 20px; font-weight: 700; text-transform: capitalize; }
.month-range { font-size: 12px; color: var(--muted); }

.month-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--primary-soft); color: var(--primary); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; }

.metrics-row {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}

.metric-card {
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 16px;
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 6px;
  background: linear-gradient(160deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.05));
}

.metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); font-weight: 600; }
.metric-value { font-size: 22px; font-weight: 700; }
.metric-sub { font-size: 11px; color: var(--muted); }

.layout {
  display: grid;
  grid-template-columns: minmax(0, 1.65fr) minmax(0, 1fr);
  gap: 20px;
  align-items: start;
}

.calendar-column, .sidebar { display: flex; flex-direction: column; gap: 20px; }

.card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
.card-header p { margin-top: 4px; }

.muted { color: var(--muted); }
.tiny { font-size: 11px; letter-spacing: 0.02em; }

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  color: var(--muted);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-weight: 600;
}

.calendar-weekdays span {
  display: flex;
  justify-content: center;
  padding-bottom: 4px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
}

.calendar-day {
  background: #fff;
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  padding: 10px 12px;
  min-height: 116px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.calendar-day:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); transform: translateY(-2px); }
.calendar-day--other-month { opacity: 0.55; }
.calendar-day--selected { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.12); }
.calendar-day--today { border-color: var(--success); }
.calendar-day--empty { background: var(--day-empty); border-color: var(--day-empty-border); }
.calendar-day--planned { background: var(--day-planned); border-color: var(--day-planned-border); }
.calendar-day--completed { background: var(--day-completed); border-color: var(--day-completed-border); }

.calendar-day-header { display: flex; justify-content: space-between; align-items: center; }
.calendar-date-number { font-weight: 700; font-size: 14px; }
.calendar-day-badges { display: flex; gap: 6px; align-items: center; }
.calendar-badge {
  background: #fff;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid rgba(148, 163, 184, 0.4);
  color: var(--muted);
}

.calendar-day-tags { display: flex; flex-wrap: wrap; gap: 4px; min-height: 32px; }
.activity-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 6px;
  border-radius: 999px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.02em;
  background: rgba(148, 163, 184, 0.18);
  color: var(--ink);
  border: 1px solid transparent;
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.activity-tag.gym { background: rgba(91, 33, 182, 0.12); color: var(--gym-color); border-color: rgba(91, 33, 182, 0.16); }
.activity-tag.running { background: rgba(4, 120, 87, 0.12); color: var(--run-color); border-color: rgba(4, 120, 87, 0.18); }
.activity-tag.reading { background: rgba(29, 78, 216, 0.12); color: var(--read-color); border-color: rgba(29, 78, 216, 0.18); }
.activity-tag.extra { background: rgba(14, 165, 233, 0.12); color: var(--extra-color); border-color: rgba(14, 165, 233, 0.18); }
.activity-tag.more { background: rgba(148, 163, 184, 0.14); color: var(--muted); border-style: dashed; }

.calendar-day-footer { margin-top: auto; font-size: 11px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; }
.calendar-footer-label { font-weight: 600; color: var(--muted); }
.calendar-day--empty .calendar-footer-label { color: var(--danger); }
.calendar-day--planned .calendar-footer-label { color: var(--warning); }
.calendar-day--completed .calendar-footer-label { color: var(--success); }

.calendar-legend { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; font-size: 11px; color: var(--muted); }
.calendar-legend span { display: inline-flex; align-items: center; gap: 6px; }
.legend-tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 10px;
  letter-spacing: 0.02em;
  background: rgba(148, 163, 184, 0.16);
  color: var(--muted);
}
.legend-tag.gym { background: rgba(91, 33, 182, 0.12); color: var(--gym-color); }
.legend-tag.running { background: rgba(4, 120, 87, 0.12); color: var(--run-color); }
.legend-tag.reading { background: rgba(29, 78, 216, 0.12); color: var(--read-color); }
.legend-tag.extra { background: rgba(14, 165, 233, 0.12); color: var(--extra-color); }

.planning-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  background: rgba(37, 99, 235, 0.08);
  border: 1px solid rgba(37, 99, 235, 0.2);
  border-radius: 14px;
  padding: 10px 12px;
}

.planning-banner.active { display: flex; }
.planning-banner-info { display: flex; align-items: center; gap: 10px; }
.planning-banner-info strong { display: block; font-size: 12px; font-weight: 700; color: var(--ink); }
.planning-banner-info span { display: block; font-size: 11px; color: var(--muted); }
.planning-banner .icon { color: var(--primary); }

.btn.small { padding: 6px 12px; font-size: 11px; border-radius: 10px; }

.calendar-card--planning { border-color: var(--primary); box-shadow: var(--shadow-sm); }
.calendar-grid.is-planning .calendar-day { cursor: crosshair; }

.upcoming-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 10px; }
.upcoming-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.25); background: rgba(248, 250, 252, 0.7); }
.upcoming-item strong { display: block; font-size: 13px; }
.upcoming-item .meta { display: flex; gap: 8px; font-size: 11px; color: var(--muted); }
.upcoming-item .badge { background: rgba(37, 99, 235, 0.12); color: var(--primary); border-radius: 999px; padding: 2px 8px; font-weight: 600; }

.empty-state {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
  padding: 18px 12px;
  border-radius: 12px;
  background: rgba(248, 250, 252, 0.7);
  border: 1px dashed rgba(148, 163, 184, 0.4);
}
.day-detail-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.detail-block { display: flex; flex-direction: column; gap: 10px; margin-top: 16px; }
.detail-block-header { font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
.detail-list { display: flex; flex-direction: column; gap: 10px; }
.detail-item {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.32);
  background: rgba(248, 250, 252, 0.8);
  transition: var(--transition);
}
.detail-item:hover { border-color: var(--primary-border); box-shadow: var(--shadow-sm); background: #fff; }
.detail-item.completed { background: var(--success-soft); border-color: var(--success-border); }
.detail-info { display: flex; gap: 12px; }
.detail-icon { width: 38px; height: 38px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 14px; }
.detail-icon.gym { background: rgba(91, 33, 182, 0.2); color: var(--gym-color); }
.detail-icon.running { background: rgba(4, 120, 87, 0.18); color: var(--run-color); }
.detail-icon.reading { background: rgba(29, 78, 216, 0.18); color: var(--read-color); }
.detail-icon.extra { background: rgba(14, 165, 233, 0.18); color: var(--extra-color); }
.detail-title { font-weight: 600; font-size: 13px; }
.detail-meta { font-size: 11px; color: var(--muted); }
.detail-actions-inline { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

.action-btn {
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  background: #fff;
  color: var(--ink);
  font-size: 11px;
  font-weight: 600;
  padding: 6px 10px;
  cursor: pointer;
  transition: var(--transition);
}

.action-btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
.action-btn.success { background: var(--success); color: #fff; border-color: var(--success); }
.action-btn.danger { border-color: rgba(220, 38, 38, 0.3); color: var(--danger); background: #fff5f5; }
.action-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }

.detail-actions { display: flex; gap: 10px; margin-top: 18px; flex-wrap: wrap; }

.priority-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 10px; }
.priority-item { display: flex; justify-content: space-between; gap: 12px; padding: 12px 14px; border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.3); background: rgba(248, 250, 252, 0.8); transition: var(--transition); }
.priority-item.completed { background: var(--success-soft); border-color: var(--success-border); }
.priority-body { display: flex; flex-direction: column; gap: 4px; }
.priority-title { font-weight: 600; font-size: 13px; }
.priority-meta { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
.priority-item.completed .priority-title { text-decoration: line-through; }
.priority-actions { display: flex; gap: 8px; }
.priority-btn { border: none; background: rgba(148, 163, 184, 0.16); border-radius: 10px; padding: 6px 8px; cursor: pointer; color: var(--muted); display: inline-flex; align-items: center; justify-content: center; transition: var(--transition); }
.priority-btn:hover { background: rgba(37, 99, 235, 0.15); color: var(--primary); }

.goal-progress-list { display: flex; flex-direction: column; gap: 14px; }
.goal-progress-item { display: flex; flex-direction: column; gap: 8px; }
.goal-progress-label { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.goal-progress-label strong { font-size: 13px; }
.goal-progress-value { font-size: 11px; font-weight: 600; color: var(--muted); }
.goal-progress-bar { width: 100%; height: 10px; border-radius: 999px; background: var(--line); overflow: hidden; }
.goal-progress-bar span { display: block; height: 100%; border-radius: 999px; transition: width .3s ease; }

.heatmap-card { display: flex; flex-direction: column; gap: 16px; }
.heatmap { display: flex; gap: 3px; overflow: hidden; padding-bottom: 8px; flex-wrap: nowrap; }
.heatmap-week { display: grid; grid-template-rows: repeat(7, 11px) auto; gap: 3px; align-items: center; }
.heatmap-cell { width: 11px; height: 11px; border-radius: 3px; background: #e2e8f0; }
.heatmap-cell[data-level="0"] { background: #e2e8f0; }
.heatmap-cell[data-level="1"] { background: #b7f3d0; }
.heatmap-cell[data-level="2"] { background: #6ee7b7; }
.heatmap-cell[data-level="3"] { background: #34d399; }
.heatmap-cell[data-level="4"] { background: #059669; }
.heatmap-cell--empty { background: transparent; }
.heatmap-month-label { font-size: 9px; text-transform: uppercase; color: var(--muted); text-align: center; letter-spacing: 0.08em; margin-top: 1px; }
.heatmap-legend { display: flex; align-items: center; justify-content: flex-end; gap: 10px; font-size: 11px; color: var(--muted); }
.heatmap-legend-scale { display: inline-flex; align-items: center; gap: 4px; }
.heatmap-legend-scale span { width: 14px; height: 14px; border-radius: 3px; background: #e2e8f0; }
.heatmap-legend-scale span[data-level="1"] { background: #b7f3d0; }
.heatmap-legend-scale span[data-level="2"] { background: #6ee7b7; }
.heatmap-legend-scale span[data-level="3"] { background: #34d399; }
.heatmap-legend-scale span[data-level="4"] { background: #059669; }
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease;
  z-index: 100;
}

.modal-overlay.visible { opacity: 1; pointer-events: all; }

.modal-card {
  background: #fff;
  padding: 28px;
  border-radius: 18px;
  max-width: 440px;
  width: 90%;
  box-shadow: var(--shadow-lg);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.modal-card h3 { font-size: 18px; font-weight: 700; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
.modal-card input, .modal-card textarea, .modal-card select { width: 100%; border: 1px solid var(--line); border-radius: 12px; padding: 12px; font-family: inherit; font-size: 13px; }
.modal-options { display: flex; flex-direction: column; gap: 10px; }
.option-label { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: var(--transition); }
.option-label:hover { border-color: var(--primary); background: var(--primary-soft); }
.option-label input { accent-color: var(--primary); }

#save-status {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--ink);
  color: #fff;
  padding: 10px 20px;
  border-radius: 14px;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s ease, transform .3s ease;
  font-size: 12px;
  z-index: 120;
}

#save-status.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

@media (max-width: 1080px) {
  .layout { grid-template-columns: 1fr; }
}

@media (max-width: 720px) {
  .wrap { padding: 24px 18px 40px; }
  .page-header-top { flex-direction: column; align-items: flex-start; }
  .page-header-actions { width: 100%; }
  .page-header-actions .btn { flex: 1; justify-content: center; }
  .metrics-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .calendar-weekdays { display: none; }
  .calendar-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
  </style>
</head>
<body>
<div class="wrap">
  <header class="page-header card">
    <div class="page-header-top">
      <div class="title-block">
        <span class="eyebrow">Program treningowy</span>
        <div class="title-row">
          <h1>Panel treningów</h1>
          <span class="month-chip" id="header-month-chip">--</span>
        </div>
      </div>
      <div class="page-header-actions">
        <a href="./index.html" class="btn ghost"><i data-lucide="arrow-left" class="icon"></i>Powrót</a>
        <button id="today-month-btn" class="btn soft"><i data-lucide="calendar" class="icon"></i>Dzisiaj</button>
      </div>
    </div>
    <div class="month-bar">
      <div class="month-controls">
        <button id="prev-month-btn" class="icon-btn" aria-label="Poprzedni miesiąc"><i data-lucide="chevron-left" class="icon"></i></button>
        <div class="month-labels">
          <h2 id="current-month-label">--</h2>
          <span class="month-range muted" id="current-month-range">--</span>
        </div>
        <button id="next-month-btn" class="icon-btn" aria-label="Następny miesiąc"><i data-lucide="chevron-right" class="icon"></i></button>
      </div>
    </div>
    <div class="metrics-row">
      <div class="metric-card">
        <span class="metric-label">Realizacja celów</span>
        <span class="metric-value" id="metric-goal-progress">0%</span>
        <span class="metric-sub" id="metric-goal-progress-sub">Cele tygodniowe</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Zamknięte działania</span>
        <span class="metric-value" id="metric-plan-completion">0/0</span>
        <span class="metric-sub">Ukończone vs zaplanowane</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Aktywne dni</span>
        <span class="metric-value" id="metric-active-days">0/0</span>
        <span class="metric-sub">Dni z planem w miesiącu</span>
      </div>
      <div class="metric-card">
        <span class="metric-label">Najbliższa aktywność</span>
        <span class="metric-value" id="metric-next-activity">Brak</span>
        <span class="metric-sub" id="metric-next-activity-date">--</span>
      </div>
    </div>
  </header>

  <main class="layout">
    <section class="calendar-column">
      <div class="card calendar-card">
        <div class="card-header">
          <div>
            <h3>Harmonogram miesięczny</h3>
            <p class="muted tiny">Planowanie i realizacja celów bez przewijania</p>
          </div>
          <div class="calendar-legend">
            <span class="legend-tag gym">Siłownia</span>
            <span class="legend-tag running">Bieganie</span>
            <span class="legend-tag reading">Czytanie</span>
            <span class="legend-tag extra">Dodatkowe</span>
          </div>
        </div>
        <div class="calendar-weekdays">
          <span>Pon</span><span>Wt</span><span>Śr</span><span>Czw</span><span>Pt</span><span>Sob</span><span>Niedz</span>
        </div>
        <div id="planning-banner" class="planning-banner" aria-live="polite">
          <div class="planning-banner-info">
            <i data-lucide="mouse-pointer" class="icon"></i>
            <div>
              <strong id="planning-banner-title">Tryb planowania</strong>
              <span id="planning-banner-meta">Wybierz typ treningu, aby rozpocząć tryb planowania wielu dni.</span>
            </div>
          </div>
          <button id="stop-planning-btn" class="btn soft small"><i data-lucide="check" class="icon"></i>Zakończ</button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
      </div>

      <div class="card overview-card">
        <div class="card-header">
          <div>
            <h3>Najbliższe działania</h3>
            <p class="muted tiny">Lista priorytetów na obecny miesiąc</p>
          </div>
        </div>
        <ul id="upcoming-list" class="upcoming-list"></ul>
        <p id="upcoming-empty" class="empty-state">Brak zaplanowanych aktywności w nadchodzących dniach.</p>
      </div>
    </section>

    <aside class="sidebar">
      <div class="card day-detail-card">
        <div class="day-detail-header">
          <div>
            <h3 id="selected-day-title">--</h3>
            <p class="muted tiny" id="selected-day-summary">Wybierz dzień z kalendarza, aby zarządzać planem.</p>
          </div>
          <span class="month-chip" id="selected-day-chip">--</span>
        </div>

        <div class="detail-block">
          <div class="detail-block-header">
            <span>Plan treningowy</span>
          </div>
          <div id="day-plan-list" class="detail-list"></div>
          <p id="day-plan-empty" class="empty-state">Brak zaplanowanych treningów na ten dzień.</p>
        </div>

        <div class="detail-block">
          <div class="detail-block-header">
            <span>Aktywności dodatkowe</span>
          </div>
          <div id="day-extra-list" class="detail-list"></div>
          <p id="day-extra-empty" class="empty-state">Dodaj krótkie działania lub przypomnienia.</p>
        </div>

        <div class="detail-actions">
          <button id="add-training-btn" class="btn"><i data-lucide="plus" class="icon"></i>Zaplanuj treningi</button>
          <button id="add-extra-btn" class="btn ghost"><i data-lucide="sparkles" class="icon"></i>Dodaj aktywność</button>
        </div>
      </div>

      <div class="card priorities-card">
        <div class="card-header">
          <div>
            <h3>Priorytety miesiąca</h3>
            <p class="muted tiny" id="priority-month-label">--</p>
          </div>
        </div>
        <ul id="priority-list" class="priority-list"></ul>
        <p id="priority-empty" class="empty-state">Ustal maksymalnie trzy kluczowe priorytety, które dociągniesz do końca miesiąca.</p>
        <button id="priority-add-btn" class="btn soft"><i data-lucide="plus-circle" class="icon"></i>Dodaj priorytet</button>
      </div>

      <div class="card analytics-card">
        <div class="card-header">
          <div>
            <h3>Postęp celów</h3>
            <p class="muted tiny">Porównanie z celami tygodniowymi</p>
          </div>
        </div>
        <div id="goal-progress-list" class="goal-progress-list"></div>
      </div>
    </aside>
  </main>

  <div class="card heatmap-card">
    <div class="card-header">
      <div>
        <h3>Historia aktywności</h3>
        <p class="muted tiny">Podsumowanie ukończonych zadań w ciągu roku</p>
      </div>
      <span class="month-chip" id="heatmap-year-label">--</span>
    </div>
    <div id="heatmap" class="heatmap"></div>
    <div class="heatmap-legend">
      <span>Brak</span>
      <div class="heatmap-legend-scale">
        <span data-level="0"></span>
        <span data-level="1"></span>
        <span data-level="2"></span>
        <span data-level="3"></span>
        <span data-level="4"></span>
      </div>
      <span>Intensywnie</span>
    </div>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title"></h3>
    <p id="modal-text" class="muted"></p>
    <div id="modal-input-container"></div>
    <div id="modal-options-container"></div>
    <div id="modal-actions" class="modal-actions"></div>
  </div>
</div>
<div id="save-status">Zapisano zmiany</div>

<script>
const STORAGE_KEY = 'lifeos_trainings_month_v1';
const LEGACY_STORAGE_KEY = 'lifeos_trainings_v1';
const MIGRATION_FLAG_KEY = 'lifeos_trainings_migrated_to_month_v1';
const GOAL_DEFINITIONS = {
  gym: { target: 3, unit: 'sesje', label: 'Trening siłowy', icon: 'dumbbell', color: 'var(--gym-color)' },
  running: { target: 5, unit: 'km', label: 'Bieganie', icon: 'activity', color: 'var(--run-color)' },
  reading: { target: 100, unit: 'stron', label: 'Czytanie', icon: 'book-open', color: 'var(--read-color)' }
};
const EXTRA_ACTIVITY_CATEGORIES = [
  { value: 'training', label: 'Trening / ruch' },
  { value: 'learning', label: 'Nauka / rozwój' },
  { value: 'relax', label: 'Regeneracja' },
  { value: 'home', label: 'Dom i organizacja' },
  { value: 'other', label: 'Inne' }
];
const EXTRA_CATEGORY_LABELS = EXTRA_ACTIVITY_CATEGORIES.reduce((acc, item) => {
  acc[item.value] = item.label;
  return acc;
}, {});
const PRIORITY_IMPACT_OPTIONS = [
  { value: 'high', label: 'Wysoki wpływ' },
  { value: 'medium', label: 'Średni wpływ' },
  { value: 'low', label: 'Lekki wpływ' }
];
const PRIORITY_IMPACT_LABELS = PRIORITY_IMPACT_OPTIONS.reduce((acc, opt) => {
  acc[opt.value] = opt.label;
  return acc;
}, {});
const MAX_PRIORITIES = 3;
const ACTIVITY_TAG_SHORT = { gym: 'Siła', running: 'Bieg', reading: 'Czyt.' };
const ACTIVITY_UNIT_SHORT = { running: 'km', reading: 'str.' };
const MAX_CALENDAR_TAGS = 4;
const DEFAULT_PLANNING_META = 'Wybierz typ treningu, aby rozpocząć tryb planowania wielu dni.';

let state = { activities: {}, extras: {}, priorities: {} };
let currentMonth = startOfMonth(new Date());
let selectedDate = toYYYYMMDD(new Date());
let planningMode = null;
let saveTimeout;

function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function toYYYYMMDD(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function parseDate(dateString) {
  const [y, m, d] = dateString.split('-').map(Number);
  return new Date(y, m - 1, d);
}

function formatMonth(date) {
  return date.toLocaleDateString('pl-PL', { month: 'long', year: 'numeric' });
}

function formatRange(start, end) {
  return `${start.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })} – ${end.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' })}`;
}

function formatDateWithDay(date) {
  return date.toLocaleDateString('pl-PL', { weekday: 'short', day: '2-digit', month: 'short' });
}

function formatPlanningSummary(type, plannedValue) {
  const def = GOAL_DEFINITIONS[type];
  if (!def) return 'Nowy trening';
  if (type === 'gym') return def.label;
  const numeric = Number(plannedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return def.label;
  const valueLabel = `${numeric.toLocaleString('pl-PL')} ${def.unit}`;
  return `${def.label} · ${valueLabel}`;
}

function getActivityTagText(activity) {
  if (!activity || !activity.type) return 'Trening';
  const short = ACTIVITY_TAG_SHORT[activity.type] || 'Plan';
  if (activity.type === 'gym') return short;
  const numeric = Number(activity.plannedValue || activity.loggedValue);
  if (!Number.isFinite(numeric) || numeric <= 0) return short;
  const unit = ACTIVITY_UNIT_SHORT[activity.type] || '';
  const value = numeric.toLocaleString('pl-PL');
  return unit ? `${short} ${value} ${unit}` : `${short} ${value}`;
}

function getExtraTagText(extra) {
  if (!extra) return 'Aktywność';
  const base = (extra.title || '').trim() || EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność';
  if (base.length <= 14) return base;
  return `${base.slice(0, 13)}…`;
}

function isPlanningActive() {
  return Boolean(planningMode && planningMode.active);
}

function startPlanningMode(type, plannedValue) {
  planningMode = {
    active: true,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0
  };
  setTimeout(() => render(), 0);
}

function stopPlanningMode() {
  if (!isPlanningActive()) return;
  planningMode = null;
  setTimeout(() => render(), 0);
}

function addDays(date, days) {
  const copy = new Date(date);
  copy.setDate(copy.getDate() + days);
  return copy;
}

function startOfWeek(date) {
  const copy = new Date(date);
  const offset = (copy.getDay() + 6) % 7;
  copy.setDate(copy.getDate() - offset);
  copy.setHours(0, 0, 0, 0);
  return copy;
}

function ensureDay(dateString) {
  if (!state.activities[dateString]) state.activities[dateString] = [];
  if (!state.extras[dateString]) state.extras[dateString] = [];
}

function ensurePriorityMonth(monthKey) {
  if (!state.priorities[monthKey]) state.priorities[monthKey] = [];
}

function sameMonth(date, reference) {
  return date.getFullYear() === reference.getFullYear() && date.getMonth() === reference.getMonth();
}

function normalizeDate(date) {
  const normalized = new Date(date);
  normalized.setHours(0, 0, 0, 0);
  return normalized;
}

function getISOWeekStart(year, week) {
  const simple = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
  const day = simple.getUTCDay();
  const diff = (day === 0 ? -6 : 1) - day;
  simple.setUTCDate(simple.getUTCDate() + diff);
  return new Date(simple.getUTCFullYear(), simple.getUTCMonth(), simple.getUTCDate());
}

function loadState() {
  state = { activities: {}, extras: {}, priorities: {} };
  planningMode = null;
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        state.activities = parsed.activities && typeof parsed.activities === 'object' ? parsed.activities : {};
        state.extras = parsed.extras && typeof parsed.extras === 'object' ? parsed.extras : {};
        state.priorities = parsed.priorities && typeof parsed.priorities === 'object' ? parsed.priorities : {};
      }
    }
  } catch (error) {
    state = { activities: {}, extras: {}, priorities: {} };
  }
  migrateLegacyState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const status = document.getElementById('save-status');
  status.classList.add('visible');
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => status.classList.remove('visible'), 1600);
}

function migrateLegacyState() {
  try {
    if (localStorage.getItem(MIGRATION_FLAG_KEY)) return;
    const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY);
    if (!legacyRaw) return;
    const legacyState = JSON.parse(legacyRaw);
    if (!legacyState || typeof legacyState !== 'object') {
      localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
      return;
    }
    let imported = false;
    Object.keys(legacyState).forEach(yearKey => {
      const weeks = legacyState[yearKey];
      if (!weeks || typeof weeks !== 'object') return;
      Object.keys(weeks).forEach(weekKey => {
        const weekData = weeks[weekKey];
        if (!weekData || typeof weekData !== 'object') return;
        const year = Number(yearKey);
        const week = Number(weekKey);
        if (!Number.isFinite(year) || !Number.isFinite(week)) return;
        const weekStart = getISOWeekStart(year, week);
        if (Number.isNaN(weekStart.getTime())) return;

        const mapDayToDate = (dayIndex) => {
          const base = new Date(weekStart);
          const offset = dayIndex === 0 ? 6 : dayIndex - 1;
          base.setDate(weekStart.getDate() + offset);
          base.setHours(0, 0, 0, 0);
          return base;
        };

        const plan = weekData.plan && typeof weekData.plan === 'object' ? weekData.plan : {};
        Object.keys(plan).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const activities = Array.isArray(plan[dayKey]) ? plan[dayKey] : [];
          activities.forEach(activity => {
            if (!activity || !activity.type || !GOAL_DEFINITIONS[activity.type]) return;
            if (state.activities[dateString].some(item => item.id === activity.id)) return;
            const plannedValue = activity.type === 'gym' ? 1 : Number(activity.plannedValue) || 0;
            const loggedValue = activity.type === 'gym'
              ? (activity.completed ? 1 : 0)
              : Number(activity.loggedValue) || (activity.completed ? plannedValue : 0);
            state.activities[dateString].push({
              id: activity.id || `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              type: activity.type,
              plannedValue,
              loggedValue,
              completed: Boolean(activity.completed),
              createdAt: activity.createdAt || Date.now()
            });
            imported = true;
          });
        });

        const extras = weekData.extras && typeof weekData.extras === 'object' ? weekData.extras : {};
        Object.keys(extras).forEach(dayKey => {
          const dayIndex = Number(dayKey);
          if (!Number.isFinite(dayIndex)) return;
          const date = mapDayToDate(dayIndex);
          const dateString = toYYYYMMDD(date);
          ensureDay(dateString);
          const list = Array.isArray(extras[dayKey]) ? extras[dayKey] : [];
          list.forEach(extra => {
            if (!extra || !extra.title) return;
            if (state.extras[dateString].some(item => item.id === extra.id)) return;
            state.extras[dateString].push({
              id: extra.id || `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
              title: extra.title,
              category: extra.category || 'other',
              completed: Boolean(extra.completed),
              createdAt: extra.createdAt || Date.now()
            });
            imported = true;
          });
        });

        const priorities = Array.isArray(weekData.priorities) ? weekData.priorities : [];
        priorities.forEach(priority => {
          if (!priority || !priority.title) return;
          const monthKey = getMonthKey(mapDayToDate(1));
          ensurePriorityMonth(monthKey);
          if (state.priorities[monthKey].some(item => item.id === priority.id)) return;
          state.priorities[monthKey].push({
            id: priority.id || `prio_${Date.now()}_${Math.random().toString(16).slice(2)}`,
            title: priority.title,
            impact: priority.impact || 'high',
            completed: Boolean(priority.completed),
            createdAt: priority.createdAt || Date.now()
          });
          imported = true;
        });
      });
    });
    if (imported) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    localStorage.setItem(MIGRATION_FLAG_KEY, 'done');
  } catch (error) {
    console.error('Legacy trainings migration failed', error);
  }
}

function getMonthKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function getCalendarDays(monthDate) {
  const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  const days = [];
  for (let i = 0; i < 42; i++) {
    const cell = new Date(start);
    cell.setDate(start.getDate() + i);
    days.push(cell);
  }
  return days;
}

function ensureSelectionInMonth() {
  const currentSelection = parseDate(selectedDate);
  if (!sameMonth(currentSelection, currentMonth)) {
    selectedDate = toYYYYMMDD(currentMonth);
  }
}

function calculateMonthlyStats(monthDate) {
  const firstDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const lastDay = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
  const totalDays = lastDay.getDate();
  const totals = { planned: 0, completed: 0 };
  const activeDays = new Set();
  const upcoming = [];
  const today = normalizeDate(new Date());

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    if (activities.length) activeDays.add(dateString);
    totals.planned += activities.length;
    activities.forEach(activity => {
      if (activity.completed) {
        totals.completed += 1;
      } else if (normalizeDate(date) >= today) {
        const goal = GOAL_DEFINITIONS[activity.type];
        if (!goal) return;
        let label = goal.label;
        if (activity.type !== 'gym' && activity.plannedValue) {
          label += ` • ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}`;
        }
        upcoming.push({
          type: activity.type,
          label,
          badge: 'Trening',
          icon: goal.icon || 'activity',
          date,
          dateLabel: formatDateWithDay(date)
        });
      }
    });
  });

  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (!sameMonth(date, monthDate)) return;
    if (extras.length) activeDays.add(dateString);
    totals.planned += extras.length;
    extras.forEach(extra => {
      if (extra.completed) {
        totals.completed += 1;
      } else if (normalizeDate(date) >= today) {
        upcoming.push({
          type: 'extra',
          label: extra.title,
          badge: EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność',
          icon: 'sparkles',
          date,
          dateLabel: formatDateWithDay(date)
        });
      }
    });
  });

  upcoming.sort((a, b) => {
    const diff = a.date - b.date;
    if (diff !== 0) return diff;
    return a.type.localeCompare(b.type);
  });

  return {
    plannedCount: totals.planned,
    completedCount: totals.completed,
    activeDays: activeDays.size,
    totalDays,
    nextActivity: upcoming.length ? { label: upcoming[0].label, dateLabel: upcoming[0].dateLabel } : null,
    upcoming,
    range: { start: firstDay, end: lastDay }
  };
}

function calculateWeeklyGoalStats(referenceDate) {
  const base = referenceDate ? new Date(referenceDate) : new Date();
  const weekStart = startOfWeek(base);
  const weekEnd = addDays(weekStart, 6);
  const totals = { gym: 0, running: 0, reading: 0 };

  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    const normalized = normalizeDate(date);
    if (normalized < weekStart || normalized > weekEnd) return;
    activities.forEach(activity => {
      if (!activity || !GOAL_DEFINITIONS[activity.type] || !activity.completed) return;
      if (activity.type === 'gym') {
        totals.gym += 1;
      } else {
        const logged = Number(activity.loggedValue);
        const planned = Number(activity.plannedValue);
        const value = !Number.isNaN(logged) && logged > 0
          ? logged
          : (!Number.isNaN(planned) ? planned : 0);
        totals[activity.type] += value;
      }
    });
  });

  const goalPercents = {};
  Object.keys(GOAL_DEFINITIONS).forEach(type => {
    const progress = totals[type] || 0;
    const target = GOAL_DEFINITIONS[type].target;
    const percent = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
    goalPercents[type] = { percent, progress, target };
  });

  const averageGoalPercent = Math.round(
    Object.values(goalPercents).reduce((acc, info) => acc + info.percent, 0) /
    Object.keys(GOAL_DEFINITIONS).length
  ) || 0;

  return { goalPercents, averageGoalPercent, range: { start: weekStart, end: weekEnd } };
}

function render() {
  ensureSelectionInMonth();
  const monthStats = calculateMonthlyStats(currentMonth);
  const weekStats = calculateWeeklyGoalStats(parseDate(selectedDate));
  renderHeader(monthStats, weekStats);
  renderCalendar();
  renderDayDetail();
  renderUpcoming(monthStats.upcoming);
  renderPriorities();
  renderGoalProgress(weekStats.goalPercents);
  renderHeatmap();
  renderPlanningIndicator();
  lucide.createIcons();
}

function renderHeader(monthStats, weekStats) {
  const monthLabel = formatMonth(currentMonth);
  document.getElementById('header-month-chip').textContent = monthLabel;
  document.getElementById('current-month-label').textContent = monthLabel;
  document.getElementById('current-month-range').textContent = `${formatRange(monthStats.range.start, monthStats.range.end)} ${currentMonth.getFullYear()}`;
  const todayButton = document.getElementById('today-month-btn');
  if (sameMonth(new Date(), currentMonth)) todayButton.style.display = 'none';
  else todayButton.style.display = 'inline-flex';
  document.getElementById('metric-goal-progress').textContent = `${weekStats.averageGoalPercent}%`;
  const goalProgressSub = document.getElementById('metric-goal-progress-sub');
  if (goalProgressSub && weekStats && weekStats.range) {
    goalProgressSub.textContent = `Cele tygodniowe · ${formatRange(weekStats.range.start, weekStats.range.end)}`;
  }
  document.getElementById('metric-plan-completion').textContent = `${monthStats.completedCount}/${monthStats.plannedCount}`;
  document.getElementById('metric-active-days').textContent = `${monthStats.activeDays}/${monthStats.totalDays}`;
  if (monthStats.nextActivity) {
    document.getElementById('metric-next-activity').textContent = monthStats.nextActivity.label;
    document.getElementById('metric-next-activity-date').textContent = monthStats.nextActivity.dateLabel;
  } else {
    document.getElementById('metric-next-activity').textContent = 'Brak';
    document.getElementById('metric-next-activity-date').textContent = '--';
  }
  document.getElementById('priority-month-label').textContent = monthLabel;
}

function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  const today = normalizeDate(new Date());
  const days = getCalendarDays(currentMonth);
  days.forEach(date => {
    const dateString = toYYYYMMDD(date);
    ensureDay(dateString);
    const activities = state.activities[dateString] || [];
    const extras = state.extras[dateString] || [];
    const plannedCount = activities.length + extras.length;
    const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    if (date.getMonth() !== currentMonth.getMonth()) cell.classList.add('calendar-day--other-month');
    if (dateString === selectedDate) cell.classList.add('calendar-day--selected');
    if (normalizeDate(date).getTime() === today.getTime()) cell.classList.add('calendar-day--today');
    if (plannedCount === 0) cell.classList.add('calendar-day--empty');
    else if (completedCount === 0) cell.classList.add('calendar-day--planned');
    else cell.classList.add('calendar-day--completed');

    const header = document.createElement('div');
    header.className = 'calendar-day-header';
    const number = document.createElement('span');
    number.className = 'calendar-date-number';
    number.textContent = date.getDate();
    header.appendChild(number);
    const badges = document.createElement('div');
    badges.className = 'calendar-day-badges';
    if (plannedCount > 0) {
      const badge = document.createElement('span');
      badge.className = 'calendar-badge';
      badge.textContent = plannedCount;
      badges.appendChild(badge);
    }
    header.appendChild(badges);
    cell.appendChild(header);

    const tags = document.createElement('div');
    tags.className = 'calendar-day-tags';
    const tagItems = [];
    activities.forEach(activity => {
      tagItems.push({
        type: activity.type,
        text: getActivityTagText(activity),
        tooltip: formatPlanningSummary(activity.type, activity.plannedValue || activity.loggedValue)
      });
    });
    extras.forEach(extra => {
      tagItems.push({
        type: 'extra',
        text: getExtraTagText(extra),
        tooltip: (extra.title || '').trim() || EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność dodatkowa'
      });
    });
    tagItems.slice(0, MAX_CALENDAR_TAGS).forEach(tag => {
      const pill = document.createElement('span');
      pill.className = `activity-tag ${tag.type}`;
      pill.textContent = tag.text;
      pill.title = tag.tooltip || tag.text;
      tags.appendChild(pill);
    });
    if (tagItems.length > MAX_CALENDAR_TAGS) {
      const more = document.createElement('span');
      more.className = 'activity-tag more';
      more.textContent = `+${tagItems.length - MAX_CALENDAR_TAGS}`;
      more.title = 'Więcej zaplanowanych aktywności';
      tags.appendChild(more);
    }
    cell.appendChild(tags);

    const footer = document.createElement('div');
    footer.className = 'calendar-day-footer';
    const done = document.createElement('span');
    done.className = 'calendar-footer-label';
    done.textContent = `${completedCount} ukończ.`;
    const remaining = document.createElement('span');
    const openCount = Math.max(0, plannedCount - completedCount);
    remaining.textContent = openCount > 0 ? `${openCount} otwarte` : '';
    footer.appendChild(done);
    footer.appendChild(remaining);
    cell.appendChild(footer);

    cell.addEventListener('click', () => {
      selectedDate = dateString;
      if (!sameMonth(date, currentMonth)) {
        currentMonth = startOfMonth(date);
      }
      if (isPlanningActive()) {
        addTraining(dateString, planningMode.type, planningMode.plannedValue);
        return;
      }
      render();
    });

    grid.appendChild(cell);
  });
}

function renderPlanningIndicator() {
  const banner = document.getElementById('planning-banner');
  const title = document.getElementById('planning-banner-title');
  const meta = document.getElementById('planning-banner-meta');
  const calendarCard = document.querySelector('.calendar-card');
  const grid = document.getElementById('calendar-grid');
  const addBtn = document.getElementById('add-training-btn');
  if (!banner || !title || !meta || !calendarCard || !grid || !addBtn) return;

  if (isPlanningActive()) {
    const summary = formatPlanningSummary(planningMode.type, planningMode.plannedValue);
    banner.classList.add('active');
    title.textContent = summary;
    meta.textContent = 'Klikaj dni w kalendarzu, aby dodać ten trening. Zakończ, gdy skończysz planować.';
    calendarCard.classList.add('calendar-card--planning');
    grid.classList.add('is-planning');
    addBtn.innerHTML = '<i data-lucide="x" class="icon"></i>Zakończ planowanie';
    addBtn.classList.add('ghost');
  } else {
    banner.classList.remove('active');
    title.textContent = 'Tryb planowania';
    meta.textContent = DEFAULT_PLANNING_META;
    calendarCard.classList.remove('calendar-card--planning');
    grid.classList.remove('is-planning');
    addBtn.innerHTML = '<i data-lucide="plus" class="icon"></i>Zaplanuj treningi';
    addBtn.classList.remove('ghost');
  }
}

function renderDayDetail() {
  ensureDay(selectedDate);
  const date = parseDate(selectedDate);
  const activities = state.activities[selectedDate] || [];
  const extras = state.extras[selectedDate] || [];
  const completedCount = activities.filter(a => a.completed).length + extras.filter(e => e.completed).length;
  const total = activities.length + extras.length;
  document.getElementById('selected-day-title').textContent = date.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' });
  document.getElementById('selected-day-summary').textContent = total > 0 ? `Zaplanowane: ${total} · Ukończone: ${completedCount}` : 'Brak zaplanowanych aktywności na ten dzień.';
  document.getElementById('selected-day-chip').textContent = date.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' }).replace('.', '').toUpperCase();

  renderDayActivities(activities);
  renderDayExtras(extras);
}

function renderDayActivities(activities) {
  const list = document.getElementById('day-plan-list');
  const empty = document.getElementById('day-plan-empty');
  list.innerHTML = '';
  if (!activities.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  activities.forEach(activity => {
    const goal = GOAL_DEFINITIONS[activity.type];
    const item = document.createElement('div');
    item.className = 'detail-item';
    if (activity.completed) item.classList.add('completed');
    const plannedInfo = activity.type === 'gym' ? 'Sesja siłowa' : (activity.plannedValue ? `Plan: ${Number(activity.plannedValue).toLocaleString('pl-PL')} ${goal.unit}` : 'Plan: brak');
    let progressInfo = '';
    if (activity.completed) {
      if (activity.type === 'gym') progressInfo = 'Sesja zakończona';
      else progressInfo = `Zrealizowano: ${Number(activity.loggedValue).toLocaleString('pl-PL')} ${goal.unit}`;
    }
    const metaText = [plannedInfo, progressInfo].filter(Boolean).join(' · ');
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon ${activity.type}"><i data-lucide="${goal.icon}" class="icon"></i></div>
        <div>
          <div class="detail-title">${goal.label}</div>
          <div class="detail-meta">${metaText}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        ${activity.completed ? `<button class="action-btn" data-action="undo-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Cofnij</button>` : `<button class="action-btn primary" data-action="complete-activity" data-day="${selectedDate}" data-type="${activity.type}" data-activity-id="${activity.id}">${activity.type === 'gym' ? 'Oznacz wykonane' : 'Zaloguj wynik'}</button>`}
        ${activity.type !== 'gym' ? `<button class="action-btn" data-action="edit-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Edytuj wynik</button>` : ''}
        <button class="action-btn danger" data-action="delete-activity" data-day="${selectedDate}" data-activity-id="${activity.id}">Usuń</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function renderDayExtras(extras) {
  const list = document.getElementById('day-extra-list');
  const empty = document.getElementById('day-extra-empty');
  list.innerHTML = '';
  if (!extras.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  extras.forEach(extra => {
    const item = document.createElement('div');
    item.className = 'detail-item';
    if (extra.completed) item.classList.add('completed');
    item.innerHTML = `
      <div class="detail-info">
        <div class="detail-icon extra"><i data-lucide="sparkles" class="icon"></i></div>
        <div>
          <div class="detail-title">${extra.title}</div>
          <div class="detail-meta">${EXTRA_CATEGORY_LABELS[extra.category] || 'Aktywność'}</div>
        </div>
      </div>
      <div class="detail-actions-inline">
        <button class="action-btn ${extra.completed ? '' : 'success'}" data-action="toggle-extra" data-day="${selectedDate}" data-extra-id="${extra.id}">${extra.completed ? 'Cofnij' : 'Zakończ'}</button>
        <button class="action-btn danger" data-action="delete-extra" data-day="${selectedDate}" data-extra-id="${extra.id}">Usuń</button>
      </div>
    `;
    list.appendChild(item);
  });
}

function renderUpcoming(upcoming) {
  const list = document.getElementById('upcoming-list');
  const empty = document.getElementById('upcoming-empty');
  list.innerHTML = '';
  const limited = upcoming.slice(0, 6);
  if (!limited.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  limited.forEach(item => {
    const li = document.createElement('li');
    li.className = 'upcoming-item';
    li.innerHTML = `
      <div class="detail-icon ${item.type === 'extra' ? 'extra' : item.type}"><i data-lucide="${item.icon}" class="icon"></i></div>
      <div>
        <strong>${item.label}</strong>
        <div class="meta">
          <span class="badge">${item.badge}</span>
          <span>${item.dateLabel}</span>
        </div>
      </div>
    `;
    list.appendChild(li);
  });
}

function renderPriorities() {
  const monthKey = getMonthKey(currentMonth);
  ensurePriorityMonth(monthKey);
  const list = document.getElementById('priority-list');
  const empty = document.getElementById('priority-empty');
  const addBtn = document.getElementById('priority-add-btn');
  const items = [...state.priorities[monthKey]];
  items.sort((a, b) => {
    if (a.completed !== b.completed) return a.completed ? 1 : -1;
    return (a.createdAt || 0) - (b.createdAt || 0);
  });
  list.innerHTML = '';
  if (!items.length) empty.style.display = 'block';
  else empty.style.display = 'none';

  items.forEach(priority => {
    const li = document.createElement('li');
    li.className = 'priority-item';
    if (priority.completed) li.classList.add('completed');
    li.innerHTML = `
      <div class="priority-body">
        <span class="priority-title">${priority.title}</span>
        <span class="priority-meta">${PRIORITY_IMPACT_LABELS[priority.impact] || ''}</span>
      </div>
      <div class="priority-actions">
        <button class="priority-btn" data-action="toggle-priority" data-month-key="${monthKey}" data-priority-id="${priority.id}"><i data-lucide="${priority.completed ? 'rotate-ccw' : 'check'}" class="icon"></i></button>
        <button class="priority-btn" data-action="delete-priority" data-month-key="${monthKey}" data-priority-id="${priority.id}"><i data-lucide="trash-2" class="icon"></i></button>
      </div>
    `;
    list.appendChild(li);
  });

  if (items.length >= MAX_PRIORITIES) {
    addBtn.disabled = true;
    addBtn.innerHTML = '<i data-lucide="check" class="icon"></i>Limit priorytetów';
  } else {
    addBtn.disabled = false;
    addBtn.innerHTML = '<i data-lucide="plus-circle" class="icon"></i>Dodaj priorytet';
  }
}

function renderGoalProgress(goalPercents) {
  const container = document.getElementById('goal-progress-list');
  container.innerHTML = '';
  if (!goalPercents) return;
  Object.entries(goalPercents).forEach(([type, info]) => {
    const def = GOAL_DEFINITIONS[type];
    const item = document.createElement('div');
    item.className = 'goal-progress-item';
    const progressValue = Number(info.progress || 0).toLocaleString('pl-PL');
    const targetValue = Number(info.target || 0).toLocaleString('pl-PL');
    item.innerHTML = `
      <div class="goal-progress-label">
        <div>
          <strong>${def.label}</strong>
          <div class="muted tiny">${progressValue} / ${targetValue} ${def.unit}</div>
        </div>
        <span class="goal-progress-value">${info.percent}%</span>
      </div>
      <div class="goal-progress-bar"><span style="width:${info.percent}%; background:${def.color};"></span></div>
    `;
    container.appendChild(item);
  });
}

function getHeatLevel(value) {
  if (value >= 5) return 4;
  if (value >= 3) return 3;
  if (value >= 2) return 2;
  if (value >= 1) return 1;
  return 0;
}

function renderHeatmap() {
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  const year = currentMonth.getFullYear();
  document.getElementById('heatmap-year-label').textContent = year;
  const counts = {};
  Object.entries(state.activities).forEach(([dateString, activities]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = activities.filter(a => a.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });
  Object.entries(state.extras).forEach(([dateString, extras]) => {
    const date = parseDate(dateString);
    if (date.getFullYear() !== year) return;
    const completed = extras.filter(e => e.completed).length;
    if (completed > 0) counts[dateString] = (counts[dateString] || 0) + completed;
  });

  const start = new Date(year, 0, 1);
  const offset = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - offset);
  for (let week = 0; week < 53; week++) {
    const column = document.createElement('div');
    column.className = 'heatmap-week';
    const weekStart = new Date(start);
    weekStart.setDate(start.getDate() + week * 7);
    for (let day = 0; day < 7; day++) {
      const current = new Date(weekStart);
      current.setDate(weekStart.getDate() + day);
      const key = toYYYYMMDD(current);
      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      if (current.getFullYear() === year) {
        const value = counts[key] || 0;
        const level = getHeatLevel(value);
        cell.dataset.level = level;
        const label = current.toLocaleDateString('pl-PL', { day: '2-digit', month: 'short' });
        cell.title = value > 0 ? `${label}: ${value} ukończone aktywności` : label;
      } else {
        cell.classList.add('heatmap-cell--empty');
      }
      column.appendChild(cell);
    }
    const label = document.createElement('span');
    label.className = 'heatmap-month-label';
    if (weekStart.getFullYear() === year) {
      label.textContent = weekStart.toLocaleDateString('pl-PL', { month: 'short' }).replace('.', '').toUpperCase();
      label.title = `${formatRange(weekStart, addDays(weekStart, 6))} ${weekStart.getFullYear()}`;
    } else {
      label.textContent = '';
    }
    column.appendChild(label);
    container.appendChild(column);
  }
}

function addTraining(dateString, type, plannedValue) {
  ensureDay(dateString);
  state.activities[dateString].push({
    id: `act_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    type,
    plannedValue: type === 'gym' ? 1 : Number(plannedValue) || 0,
    loggedValue: 0,
    completed: false,
    createdAt: Date.now()
  });
  saveState();
  render();
}

function addExtra(dateString, title, category) {
  ensureDay(dateString);
  state.extras[dateString].push({
    id: `extra_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    title,
    category,
    completed: false,
    createdAt: Date.now()
  });
  saveState();
  render();
}

function addPriority(title, impact) {
  const monthKey = getMonthKey(currentMonth);
  ensurePriorityMonth(monthKey);
  if (state.priorities[monthKey].length >= MAX_PRIORITIES) return;
  state.priorities[monthKey].push({
    id: `prio_${Date.now()}_${Math.random().toString(16).slice(2)}`,
    title,
    impact,
    completed: false,
    createdAt: Date.now()
  });
  saveState();
  render();
}

function togglePriority(id, monthKey) {
  const list = state.priorities[monthKey] || [];
  const priority = list.find(p => p.id === id);
  if (!priority) return;
  priority.completed = !priority.completed;
  saveState();
  render();
}

function deletePriority(id, monthKey) {
  if (!state.priorities[monthKey]) return;
  state.priorities[monthKey] = state.priorities[monthKey].filter(p => p.id !== id);
  saveState();
  render();
}

function completeActivity(day, id) {
  const activities = state.activities[day] || [];
  const activity = activities.find(a => a.id === id);
  if (!activity) return;
  if (activity.type === 'gym') {
    activity.completed = true;
    activity.loggedValue = 1;
    saveState();
    render();
  } else {
    showLogModal(activity, day);
  }
}

function showLogModal(activity, day) {
  const goal = GOAL_DEFINITIONS[activity.type];
  showModal({
    title: `Zaloguj ${goal.label.toLowerCase()}`,
    text: `Podaj zrealizowaną wartość dla ${formatDateWithDay(parseDate(day))}.`,
    input: { type: 'number', value: activity.loggedValue || activity.plannedValue || '', placeholder: `Wartość w ${goal.unit}`, min: '0', step: '1' },
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Zapisz', class: 'btn', action: (value) => {
          const numeric = Number(value);
          if (!numeric || numeric <= 0) return false;
          activity.loggedValue = numeric;
          activity.completed = true;
          saveState();
          render();
        } }
    ]
  });
}

function editActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity || activity.type === 'gym') return;
  showLogModal(activity, day);
}

function undoActivity(day, id) {
  const activity = (state.activities[day] || []).find(a => a.id === id);
  if (!activity) return;
  activity.completed = false;
  activity.loggedValue = 0;
  saveState();
  render();
}

function deleteActivity(day, id) {
  if (!state.activities[day]) return;
  state.activities[day] = state.activities[day].filter(a => a.id !== id);
  saveState();
  render();
}

function toggleExtra(day, id) {
  const extra = (state.extras[day] || []).find(e => e.id === id);
  if (!extra) return;
  extra.completed = !extra.completed;
  saveState();
  render();
}

function deleteExtra(day, id) {
  if (!state.extras[day]) return;
  state.extras[day] = state.extras[day].filter(e => e.id !== id);
  saveState();
  render();
}

function showAddTrainingModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Zaplanuj trening',
    text: `Dodaj aktywność na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    input: { type: 'number', placeholder: 'Docelowa wartość', min: '0', step: '1' },
    options: [
      { value: 'gym', label: 'Trening siłowy', checked: true },
      { value: 'running', label: 'Bieganie' },
      { value: 'reading', label: 'Czytanie' }
    ],
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Planowanie wielu dni', class: 'btn ghost', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            startPlanningMode(type, numeric);
          } else {
            startPlanningMode(type, 1);
          }
        } },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const type = selected || 'gym';
          if (type !== 'gym') {
            const numeric = Number(value);
            if (!numeric || numeric <= 0) return false;
            addTraining(selectedDate, type, numeric);
          } else {
            addTraining(selectedDate, type, 1);
          }
        } }
    ],
    onShow: ({ overlay, input }) => {
      const radios = overlay.querySelectorAll('input[name="modal-option"]');
      const update = () => {
        const type = overlay.querySelector('input[name="modal-option"]:checked')?.value;
        if (!input) return;
        if (type === 'gym') {
          input.value = '';
          input.placeholder = 'Sesja siłowa – bez dodatkowej wartości';
          input.disabled = true;
        } else if (type === 'running') {
          input.disabled = false;
          input.placeholder = 'Cel w kilometrach';
        } else if (type === 'reading') {
          input.disabled = false;
          input.placeholder = 'Cel w stronach';
        }
      };
      update();
      radios.forEach(radio => radio.addEventListener('change', update));
    }
  });
}

function showAddExtraModal() {
  const date = parseDate(selectedDate);
  showModal({
    title: 'Dodaj aktywność dodatkową',
    text: `Dodaj drobne działanie na ${date.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long' })}.`,
    textarea: { placeholder: 'Opis aktywności' },
    options: EXTRA_ACTIVITY_CATEGORIES.map((cat, index) => ({ value: cat.value, label: cat.label, checked: index === 0 })),
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const textValue = (value || '').trim();
          if (!textValue) return false;
          addExtra(selectedDate, textValue, selected || 'other');
        } }
    ]
  });
}

function showPriorityModal() {
  const monthKey = getMonthKey(currentMonth);
  ensurePriorityMonth(monthKey);
  if (state.priorities[monthKey].length >= MAX_PRIORITIES) return;
  showModal({
    title: 'Nowy priorytet',
    text: `Określ priorytet na ${formatMonth(currentMonth)}.`,
    textarea: { placeholder: 'Opisz priorytet' },
    options: PRIORITY_IMPACT_OPTIONS.map((opt, index) => ({ value: opt.value, label: opt.label, checked: index === 0 })),
    buttons: [
      { text: 'Anuluj', class: 'btn soft', action: 'close' },
      { text: 'Dodaj', class: 'btn', action: (value, selected) => {
          const textValue = (value || '').trim();
          if (!textValue) return false;
          addPriority(textValue, selected || 'high');
        } }
    ]
  });
}

function showModal(config) {
  const overlay = document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent = config.title || '';
  document.getElementById('modal-text').innerHTML = config.text || '';
  const inputContainer = document.getElementById('modal-input-container');
  const optionsContainer = document.getElementById('modal-options-container');
  const actions = document.getElementById('modal-actions');
  inputContainer.innerHTML = '';
  optionsContainer.innerHTML = '';
  actions.innerHTML = '';

  if (config.input) {
    const input = document.createElement('input');
    input.type = config.input.type || 'text';
    if (config.input.placeholder) input.placeholder = config.input.placeholder;
    if (config.input.value !== undefined) input.value = config.input.value;
    if (config.input.min !== undefined) input.min = config.input.min;
    if (config.input.step !== undefined) input.step = config.input.step;
    if (config.input.disabled) input.disabled = true;
    input.autocomplete = 'off';
    input.dataset.modalInput = 'true';
    inputContainer.appendChild(input);
  }

  if (config.textarea) {
    const textarea = document.createElement('textarea');
    textarea.placeholder = config.textarea.placeholder || '';
    textarea.value = config.textarea.value || '';
    textarea.rows = config.textarea.rows || 4;
    textarea.dataset.modalInput = 'true';
    inputContainer.appendChild(textarea);
  }

  if (config.options) {
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'modal-options';
    config.options.forEach(opt => {
      const label = document.createElement('label');
      label.className = 'option-label';
      label.innerHTML = `<input type="radio" name="modal-option" value="${opt.value}" ${opt.checked ? 'checked' : ''}> <span>${opt.label}</span>`;
      optionsDiv.appendChild(label);
    });
    optionsContainer.appendChild(optionsDiv);
  }

  config.buttons.forEach(btn => {
    const button = document.createElement('button');
    button.textContent = btn.text;
    button.className = btn.class;
    button.addEventListener('click', () => {
      if (btn.action === 'close') {
        overlay.classList.remove('visible');
        return;
      }
      const field = inputContainer.querySelector('[data-modal-input]');
      const selectedOption = optionsContainer.querySelector('input[name="modal-option"]:checked')?.value;
      const value = field ? field.value : '';
      const result = btn.action(value, selectedOption);
      if (result === false) return;
      overlay.classList.remove('visible');
    });
    actions.appendChild(button);
  });

  overlay.classList.add('visible');
  if (typeof config.onShow === 'function') {
    config.onShow({ overlay, input: inputContainer.querySelector('[data-modal-input]'), optionsContainer });
  }
  const focusTarget = inputContainer.querySelector('[data-modal-input]');
  if (focusTarget && !focusTarget.disabled) focusTarget.focus();
}

function setupEventListeners() {
  document.getElementById('prev-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
    render();
  });
  document.getElementById('next-month-btn').addEventListener('click', () => {
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
    render();
  });
  document.getElementById('today-month-btn').addEventListener('click', () => {
    const today = new Date();
    currentMonth = startOfMonth(today);
    selectedDate = toYYYYMMDD(today);
    render();
  });
  document.getElementById('add-training-btn').addEventListener('click', () => {
    if (isPlanningActive()) {
      stopPlanningMode();
    } else {
      showAddTrainingModal();
    }
  });
  document.getElementById('stop-planning-btn').addEventListener('click', () => stopPlanningMode());
  document.getElementById('add-extra-btn').addEventListener('click', showAddExtraModal);
  document.getElementById('priority-add-btn').addEventListener('click', showPriorityModal);

  document.getElementById('day-plan-list').addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const day = target.dataset.day;
    const id = target.dataset.activityId;
    const action = target.dataset.action;
    if (action === 'complete-activity') completeActivity(day, id);
    if (action === 'undo-activity') undoActivity(day, id);
    if (action === 'delete-activity') deleteActivity(day, id);
    if (action === 'edit-activity') editActivity(day, id);
  });

  document.getElementById('day-extra-list').addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const day = target.dataset.day;
    const id = target.dataset.extraId;
    const action = target.dataset.action;
    if (action === 'toggle-extra') toggleExtra(day, id);
    if (action === 'delete-extra') deleteExtra(day, id);
  });

  document.getElementById('priority-list').addEventListener('click', (event) => {
    const target = event.target.closest('[data-action]');
    if (!target) return;
    const monthKey = target.dataset.monthKey;
    const id = target.dataset.priorityId;
    const action = target.dataset.action;
    if (action === 'toggle-priority') togglePriority(id, monthKey);
    if (action === 'delete-priority') deletePriority(id, monthKey);
  });

  document.getElementById('modal-overlay').addEventListener('click', (event) => {
    if (event.target === event.currentTarget) {
      event.currentTarget.classList.remove('visible');
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  loadState();
  ensureDay(selectedDate);
  render();
  setupEventListeners();
});
</script>
</body>
</html>
